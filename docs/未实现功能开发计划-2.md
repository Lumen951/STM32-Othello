# STM32 Othello é¡¹ç›®æœªå®ç°åŠŸèƒ½å¼€å‘è®¡åˆ’ v2.0

**æ–‡æ¡£åˆ›å»ºæ—¥æœŸ**: 2025-12-17
**é¡¹ç›®ç‰ˆæœ¬**: 1.0
**æœ€æ–°commit**: d7cc468 (2025-12-15)

---

## ğŸ“‹ æ‰§è¡Œæ¦‚è¦

æœ¬æ–‡æ¡£é’ˆå¯¹é¡¹ç›®è¦æ±‚ä¸­å°šæœªå®ç°æˆ–éœ€è¦ä¿®å¤çš„åŠŸèƒ½ï¼Œåˆ¶å®šè¯¦ç»†çš„å¼€å‘è®¡åˆ’ã€‚åŸºäºå¯¹ç°æœ‰ä»£ç çš„å…¨é¢reviewï¼Œä»¥ä¸‹æ˜¯éœ€è¦å®Œæˆçš„ä¸»è¦ä»»åŠ¡ï¼š

### å…³é”®é—®é¢˜
1. âŒ **é€šè®¯ç¨³å®šæ€§é—®é¢˜** - ä¸Šä½æœºè¿æ¥æ˜¾ç¤ºä¸ç¨³å®šã€ä¸‹ä½æœºæ— æ³•æ­£å¸¸å›ä¼ çŠ¶æ€ã€ä¸‹æ£‹å­˜åœ¨å»¶è¿Ÿ
2. âš ï¸ **ä¸²å£è®¾ç½®åŠŸèƒ½ä¸å®Œæ•´** - æ•°æ®ä½ã€åœæ­¢ä½ã€æ ¡éªŒä½è®¾ç½®æœªå®é™…åº”ç”¨
3. âŒ **ä½œå¼Šæ¨¡å¼å®Œå…¨ç¼ºå¤±** - ä¸Šä¸‹ä½æœºå‡æœªå®ç°ç¼–è¾‘æ£‹ç›˜åŠŸèƒ½
4. âš ï¸ **å†å²å›çœ‹/æ’è¡Œæ¦œå…¥å£é—®é¢˜** - åŠŸèƒ½å·²å®ç°ä½†å¯èƒ½å…¥å£ä¸æ˜æ˜¾

---

## âœ… å·²éªŒè¯çš„å®ç°æƒ…å†µ

### å®Œå…¨å®ç°çš„åŠŸèƒ½
- âœ… **ä¸²å£è®¾ç½®å¯¹è¯æ¡†**: `serial_settings_dialog.py` (ç¬¬1-396è¡Œ)
  - åŒ…å«ç«¯å£ã€æ³¢ç‰¹ç‡ã€æ•°æ®ä½ã€åœæ­¢ä½ã€æ ¡éªŒä½çš„UI
  - **ä½†å­˜åœ¨Bug**: æ•°æ®ä½ã€åœæ­¢ä½ã€æ ¡éªŒä½è®¾ç½®æœªå®é™…åº”ç”¨åˆ°ä¸²å£è¿æ¥

- âœ… **å†å²å›çœ‹çª—å£**: `history_viewer.py` (ç¬¬1-407è¡Œ)
  - å®Œæ•´çš„å›æ”¾åŠŸèƒ½ï¼ˆå‰è¿›/åé€€/è·³è½¬/è‡ªåŠ¨æ’­æ”¾ï¼‰
  - å…¥å£ï¼šèœå•æ  â†’ æ¸¸æˆ â†’ å†å²å›çœ‹

- âœ… **æ’è¡Œæ¦œçª—å£**: `leaderboard_window.py` (ç¬¬1-282è¡Œ)
  - åˆ†æ¨¡å¼æ’è¡Œæ¦œï¼ˆæ™®é€š/é—¯å…³/è®¡æ—¶ï¼‰
  - æ”¯æŒå¯¼å‡ºCSV
  - å…¥å£ï¼šèœå•æ  â†’ æ¸¸æˆ â†’ æ’è¡Œæ¦œ

- âœ… **è®¡æ—¶æ¨¡å¼**: `timed_mode.py` (ä¸Šä½æœºå®Œæ•´å®ç°)
  - ä¸Šä½æœºå€’è®¡æ—¶ç®¡ç†å™¨
  - ä¸‹ä½æœºé€šè¿‡CMD_TIMER_UPDATE (0x0F) æ¥æ”¶ä¸Šä½æœºåŒæ­¥

### éƒ¨åˆ†å®ç°/æœ‰é—®é¢˜çš„åŠŸèƒ½
- âš ï¸ **é€šè®¯åè®®**: åè®®å®šä¹‰å®Œæ•´ï¼Œä½†å®é™…è¿è¡Œä¸ç¨³å®š
- âš ï¸ **ä¸²å£å‚æ•°åº”ç”¨**: UIå­˜åœ¨ï¼Œä½†æœªå®é™…åº”ç”¨åˆ°ä¸²å£å¯¹è±¡

### å®Œå…¨ç¼ºå¤±çš„åŠŸèƒ½
- âŒ **ä½œå¼Šæ¨¡å¼**: ä¸Šä¸‹ä½æœºå‡æœªå®ç°

---

## ğŸ¯ å¼€å‘ä»»åŠ¡æ¸…å•

### ä¼˜å…ˆçº§1: é€šè®¯ç¨³å®šæ€§ä¿®å¤ï¼ˆå¿…é¡»å®Œæˆï¼‰

#### ä»»åŠ¡1.1: ä¿®å¤ä¸²å£å‚æ•°åº”ç”¨Bug
**ä½ç½®**: `OthelloPC/communication/serial_handler.py`

**é—®é¢˜æè¿°**:
- ä¸²å£è®¾ç½®å¯¹è¯æ¡†å…è®¸ç”¨æˆ·è®¾ç½®æ•°æ®ä½ã€åœæ­¢ä½ã€æ ¡éªŒä½
- ä½†`SerialHandler.connect()` æ–¹æ³•ç¡¬ç¼–ç äº†è¿™äº›å‚æ•°ï¼Œæœªä»configè¯»å–

**å½“å‰ä»£ç ** (serial_handler.py:197-204):
```python
self.serial_port = serial.Serial(
    port=self.port_name,
    baudrate=self.baud_rate,
    bytesize=serial.EIGHTBITS,      # ç¡¬ç¼–ç 8ä½
    parity=serial.PARITY_NONE,      # ç¡¬ç¼–ç æ— æ ¡éªŒ
    stopbits=serial.STOPBITS_ONE,   # ç¡¬ç¼–ç 1åœæ­¢ä½
    timeout=1.0,
    write_timeout=1.0
)
```

**ä¿®å¤æ–¹æ¡ˆ**:
```python
# ä»configè¯»å–ä¸²å£å‚æ•°
data_bits_map = {5: serial.FIVEBITS, 6: serial.SIXBITS, 7: serial.SEVENBITS, 8: serial.EIGHTBITS}
stop_bits_map = {1: serial.STOPBITS_ONE, 1.5: serial.STOPBITS_ONE_POINT_FIVE, 2: serial.STOPBITS_TWO}
parity_map = {
    'None': serial.PARITY_NONE,
    'Odd': serial.PARITY_ODD,
    'Even': serial.PARITY_EVEN,
    'Mark': serial.PARITY_MARK,
    'Space': serial.PARITY_SPACE
}

data_bits = data_bits_map.get(self.config.get('serial.data_bits', 8), serial.EIGHTBITS)
stop_bits = stop_bits_map.get(self.config.get('serial.stop_bits', 1), serial.STOPBITS_ONE)
parity = parity_map.get(self.config.get('serial.parity', 'None'), serial.PARITY_NONE)

self.serial_port = serial.Serial(
    port=self.port_name,
    baudrate=self.baud_rate,
    bytesize=data_bits,
    parity=parity,
    stopbits=stop_bits,
    timeout=1.0,
    write_timeout=1.0
)
```

**ä¿®æ”¹æ–‡ä»¶**:
- `OthelloPC/communication/serial_handler.py` (ç¬¬197-204è¡Œ)

**æµ‹è¯•éªŒè¯**:
1. åœ¨ä¸²å£è®¾ç½®ä¸­ä¿®æ”¹æ•°æ®ä½ä¸º7ä½
2. ä¿å­˜å¹¶é‡æ–°è¿æ¥
3. ä½¿ç”¨ä¸²å£ç›‘æ§å·¥å…·éªŒè¯å®é™…é…ç½®

---

#### ä»»åŠ¡1.2: å¢å¼ºè¿æ¥éªŒè¯æœºåˆ¶
**ä½ç½®**: `OthelloPC/communication/serial_handler.py`

**é—®é¢˜æè¿°**:
- å½“å‰è¿æ¥éªŒè¯ä»…å‘é€ä¸€æ¬¡CMD_SYSTEM_INFOï¼Œå®¹æ˜“è¶…æ—¶
- æ²¡æœ‰é‡è¯•æœºåˆ¶

**ä¿®å¤æ–¹æ¡ˆ**:
1. **å¢åŠ é‡è¯•æœºåˆ¶** (åœ¨`send_system_info_request`ä¸­):
```python
def send_system_info_request_with_retry(self, max_retries=3):
    """å‘é€ç³»ç»Ÿä¿¡æ¯è¯·æ±‚ï¼ˆå¸¦é‡è¯•ï¼‰"""
    for attempt in range(max_retries):
        success = self.send_system_info_request()
        if success:
            self.logger.info(f"ç³»ç»Ÿä¿¡æ¯è¯·æ±‚å·²å‘é€ (å°è¯• {attempt + 1}/{max_retries})")
            return True
        time.sleep(0.3)  # æ¯æ¬¡é‡è¯•é—´éš”300ms
    return False
```

2. **å¢åŠ å“åº”è¶…æ—¶å¤„ç†** (åœ¨`_parse_received_data`ä¸­):
```python
# å½“æ”¶åˆ°CMD_SYSTEM_INFOå“åº”æ—¶ï¼Œè®¾ç½®è¿æ¥éªŒè¯æ ‡å¿—
if command == CMD_SYSTEM_INFO:
    self.connection_verified = True
    self.connection_verified_time = time.time()
```

3. **ä¿®æ”¹main_window.pyä¸­çš„è¿æ¥éªŒè¯**:
```python
def _connect_stm32(self):
    # ... ç°æœ‰è¿æ¥ä»£ç  ...

    # ä½¿ç”¨é‡è¯•æœºåˆ¶å‘é€ç³»ç»Ÿä¿¡æ¯è¯·æ±‚
    self.serial_handler.send_system_info_request_with_retry(max_retries=3)

    # éªŒè¯è¿æ¥ï¼ˆå¢åŠ è¶…æ—¶æ—¶é—´åˆ°5ç§’ï¼Œæ¯500msæ£€æŸ¥ä¸€æ¬¡ï¼‰
    self._connection_timeout_count = 0
    self._verify_connection_timer()
```

**ä¿®æ”¹æ–‡ä»¶**:
- `OthelloPC/communication/serial_handler.py` (æ·»åŠ æ–°æ–¹æ³•)
- `OthelloPC/gui/main_window.py` (ç¬¬381-430è¡Œ)

**æµ‹è¯•éªŒè¯**:
1. æµ‹è¯•æ­£å¸¸è¿æ¥ï¼ˆSTM32æ­£å¸¸è¿è¡Œï¼‰
2. æµ‹è¯•å¼‚å¸¸æƒ…å†µï¼ˆSTM32æœªè¿è¡Œï¼‰
3. æµ‹è¯•å¼±ä¿¡å·æƒ…å†µï¼ˆUSBçº¿é•¿/æ¥è§¦ä¸è‰¯ï¼‰

---

#### ä»»åŠ¡1.3: ä¿®å¤ä¸‹ä½æœºçŠ¶æ€å›ä¼ é—®é¢˜
**ä½ç½®**: `Core/Src/uart_protocol.c`

**é—®é¢˜æè¿°**:
- ä¸‹ä½æœºå¯èƒ½æœªåŠæ—¶å‘é€æ¸¸æˆçŠ¶æ€
- UARTå‘é€ç¼“å†²åŒºå¯èƒ½æº¢å‡º

**ä¿®å¤æ–¹æ¡ˆ**:

1. **å¢åŠ å‘é€ç¡®è®¤æœºåˆ¶**:
```c
// åœ¨uart_protocol.cä¸­æ·»åŠ 
static volatile bool waiting_for_ack = false;
static uint32_t last_send_time = 0;

Protocol_Status_t Protocol_SendGameState(const Game_State_Data_t* game_state) {
    if (!game_state) {
        return PROTOCOL_ERROR;
    }

    // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç­‰å¾…ä¸Šæ¬¡å‘é€çš„ACK
    if (waiting_for_ack && (HAL_GetTick() - last_send_time < 500)) {
        return PROTOCOL_BUSY;  // ä¸Šæ¬¡å‘é€è¿˜æœªå®Œæˆï¼Œç¨åé‡è¯•
    }

    Protocol_Status_t status = Protocol_SendPacket(CMD_BOARD_STATE,
                                                   (uint8_t*)game_state,
                                                   sizeof(Game_State_Data_t));

    if (status == PROTOCOL_OK) {
        waiting_for_ack = true;
        last_send_time = HAL_GetTick();
    }

    return status;
}

// åœ¨æ”¶åˆ°ACKæ—¶æ¸…é™¤æ ‡å¿—
void Protocol_OnAckReceived(uint8_t original_cmd) {
    if (original_cmd == CMD_BOARD_STATE) {
        waiting_for_ack = false;
    }
}
```

2. **å¢åŠ UART DMAå‘é€æ¨¡å¼** (å¦‚æœå½“å‰ä½¿ç”¨è½®è¯¢æ¨¡å¼):
```c
// åœ¨uart_protocol.cä¸­
HAL_StatusTypeDef Protocol_UART_Transmit(uint8_t* data, uint16_t size) {
    #ifdef USE_UART_DMA
        return HAL_UART_Transmit_DMA(&huart1, data, size);
    #else
        return HAL_UART_Transmit(&huart1, data, size, 100);  // 100msè¶…æ—¶
    #endif
}
```

3. **å¢åŠ å‘é€é˜Ÿåˆ—** (é˜²æ­¢æ•°æ®ä¸¢å¤±):
```c
#define TX_QUEUE_SIZE 8

typedef struct {
    uint8_t buffer[PROTOCOL_MAX_PACKET_SIZE];
    uint16_t length;
} TX_Packet_t;

static TX_Packet_t tx_queue[TX_QUEUE_SIZE];
static uint8_t tx_queue_head = 0;
static uint8_t tx_queue_tail = 0;

// å…¥é˜Ÿ
bool Protocol_EnqueuePacket(uint8_t* data, uint16_t size);

// åœ¨ä¸»å¾ªç¯æˆ–ä¸­æ–­ä¸­å‡ºé˜Ÿå¹¶å‘é€
void Protocol_ProcessTxQueue(void);
```

**ä¿®æ”¹æ–‡ä»¶**:
- `Core/Src/uart_protocol.c` (ç¬¬370-400è¡Œé™„è¿‘)
- `Core/Inc/uart_protocol.h` (æ·»åŠ æ–°å‡½æ•°å£°æ˜)

**æµ‹è¯•éªŒè¯**:
1. å¿«é€Ÿè¿ç»­å‘é€å¤šæ¬¡èµ°æ£‹å‘½ä»¤
2. ç›‘æ§STM32æ˜¯å¦æ¯æ¬¡éƒ½å›ä¼ çŠ¶æ€
3. ä½¿ç”¨é€»è¾‘åˆ†æä»ªç›‘æ§UARTä¿¡å·

---

#### ä»»åŠ¡1.4: ä¼˜åŒ–èµ°æ£‹å»¶è¿Ÿ
**ä½ç½®**: ä¸Šä½æœºå’Œä¸‹ä½æœº

**é—®é¢˜æè¿°**:
- ä¸Šä½æœºå‘é€èµ°æ£‹å‘½ä»¤åï¼Œä¸‹ä½æœºå“åº”æ…¢
- å¯èƒ½æ˜¯å¤„ç†æµç¨‹è¿‡é•¿

**ä¿®å¤æ–¹æ¡ˆ**:

1. **ä¸‹ä½æœºä¼˜åŒ–** (main.c):
```c
// åœ¨main.cçš„ä¸»å¾ªç¯ä¸­ï¼Œä¼˜å…ˆå¤„ç†åè®®å‘½ä»¤
void App_Main_Loop(void) {
    // 1. ä¼˜å…ˆå¤„ç†UARTåè®®ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    Protocol_Task();

    // 2. å¿«é€Ÿæ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„å‘½ä»¤
    if (Protocol_IsPacketReady()) {
        uint8_t data[256];
        uint8_t len;
        Protocol_Command_t cmd;

        if (Protocol_GetPacket(&cmd, data, &len) == PROTOCOL_OK) {
            Protocol_Command_Handler(cmd, data, len);

            // å¦‚æœæ˜¯èµ°æ£‹å‘½ä»¤ï¼Œç«‹å³æ›´æ–°LEDæ˜¾ç¤º
            if (cmd == CMD_MAKE_MOVE) {
                App_DisplayGameBoard();
            }
        }
    }

    // 3. å…¶ä»–ä»»åŠ¡
    Keypad_Scan_Task();

    // å‡å°‘ä¸å¿…è¦çš„å»¶è¿Ÿ
    HAL_Delay(1);  // æ”¹ä¸º1msï¼ˆä¹‹å‰å¯èƒ½æ›´é•¿ï¼‰
}
```

2. **ä¸Šä½æœºä¼˜åŒ–** (main_window.py):
```python
def _on_player_move(self, row: int, col: int):
    # å…ˆéªŒè¯èµ°æ³•
    game_state = self.game_manager.current_game
    if not game_state.is_valid_move(row, col, game_state.current_player):
        return

    # ä¿å­˜å½“å‰ç©å®¶
    current_player = self.game_manager.current_game.current_player.value

    # ç«‹å³æ›´æ–°UIï¼ˆä¸ç­‰STM32å“åº”ï¼‰
    success = self.game_manager.make_move(row, col)
    if success:
        self.game_board.update_board()
        self.game_board.highlight_last_move()

        # å¼‚æ­¥å‘é€åˆ°STM32ï¼ˆä¸é˜»å¡UIï¼‰
        if self.serial_handler.is_connected():
            # ä½¿ç”¨çº¿ç¨‹æ± é¿å…é˜»å¡
            threading.Thread(
                target=lambda: self.serial_handler.send_make_move(row, col, current_player),
                daemon=True
            ).start()
```

**ä¿®æ”¹æ–‡ä»¶**:
- `Core/Src/main.c` (ä¸»å¾ªç¯)
- `OthelloPC/gui/main_window.py` (ç¬¬749-785è¡Œ)

**æµ‹è¯•éªŒè¯**:
1. æµ‹é‡ä¸Šä½æœºç‚¹å‡»åˆ°LEDæ›´æ–°çš„å»¶è¿Ÿæ—¶é—´
2. ç›®æ ‡ï¼š< 200ms

---

### ä¼˜å…ˆçº§2: ä½œå¼Šæ¨¡å¼å®ç°ï¼ˆè¿›é˜¶è¦æ±‚ï¼‰

#### ä»»åŠ¡2.1: ä¸‹ä½æœºä½œå¼Šæ¨¡å¼å®ç°

**æ–°å¢æ–‡ä»¶**: `Core/Src/cheat_mode.c` å’Œ `Core/Inc/cheat_mode.h`

**cheat_mode.h** å†…å®¹:
```c
/**
 * @file cheat_mode.h
 * @brief Cheat Mode (Board Editor) Header
 * @version 1.0
 */

#ifndef CHEAT_MODE_H
#define CHEAT_MODE_H

#include <stdint.h>
#include <stdbool.h>
#include "othello_engine.h"

/* ä½œå¼Šæ¨¡å¼çŠ¶æ€ */
typedef enum {
    CHEAT_MODE_INACTIVE = 0,     // æœªæ¿€æ´»
    CHEAT_MODE_ACTIVE,            // å·²æ¿€æ´»ï¼ˆç­‰å¾…ç¼–è¾‘ï¼‰
    CHEAT_MODE_SELECTING          // æ­£åœ¨é€‰æ‹©ä½ç½®
} Cheat_Mode_State_t;

/* ä½œå¼Šæ¨¡å¼ä¸Šä¸‹æ–‡ */
typedef struct {
    bool initialized;
    Cheat_Mode_State_t state;

    // å…‰æ ‡ä½ç½®
    uint8_t cursor_row;
    uint8_t cursor_col;

    // è¦æ”¾ç½®çš„æ£‹å­ç±»å‹
    PieceType_t piece_to_place;

    // å¤‡ä»½åŸå§‹æ£‹ç›˜ï¼ˆç”¨äºå–æ¶ˆç¼–è¾‘ï¼‰
    GameState_t backup_state;

    // ç¼–è¾‘è®¡æ•°
    uint16_t edit_count;
} Cheat_Mode_Context_t;

/* å‡½æ•°å£°æ˜ */
Cheat_Mode_Context_t* Cheat_Mode_Init(void);
void Cheat_Mode_Enter(GameState_t* game_state);
void Cheat_Mode_Exit(bool save_changes);
void Cheat_Mode_SetPiece(GameState_t* game_state, uint8_t row, uint8_t col, PieceType_t piece);
void Cheat_Mode_ClearPiece(GameState_t* game_state, uint8_t row, uint8_t col);
void Cheat_Mode_MoveCursor(int8_t delta_row, int8_t delta_col);
void Cheat_Mode_SelectPieceType(PieceType_t piece);
Cheat_Mode_State_t Cheat_Mode_GetState(void);

// æŒ‰é”®å¤„ç†
void Cheat_Mode_HandleKey(Keypad_LogicalKey_t key, GameState_t* game_state);

#endif // CHEAT_MODE_H
```

**cheat_mode.c** å…³é”®å®ç°:
```c
#include "cheat_mode.h"
#include "led_text.h"
#include "ws2812b_driver.h"
#include "keypad_mapping.h"
#include <string.h>

static Cheat_Mode_Context_t cheat_ctx = {0};

Cheat_Mode_Context_t* Cheat_Mode_Init(void) {
    memset(&cheat_ctx, 0, sizeof(Cheat_Mode_Context_t));
    cheat_ctx.state = CHEAT_MODE_INACTIVE;
    cheat_ctx.piece_to_place = PIECE_BLACK;
    cheat_ctx.initialized = true;
    return &cheat_ctx;
}

void Cheat_Mode_Enter(GameState_t* game_state) {
    if (!cheat_ctx.initialized || !game_state) {
        return;
    }

    // å¤‡ä»½å½“å‰æ£‹ç›˜
    memcpy(&cheat_ctx.backup_state, game_state, sizeof(GameState_t));

    // è¿›å…¥ç¼–è¾‘æ¨¡å¼
    cheat_ctx.state = CHEAT_MODE_ACTIVE;
    cheat_ctx.cursor_row = 3;
    cheat_ctx.cursor_col = 3;
    cheat_ctx.edit_count = 0;

    // æ˜¾ç¤º"EDIT"æç¤ºï¼ˆ2ç§’ï¼‰
    LED_Text_Display("EDIT", WS2812B_COLOR_BLUE);
    HAL_Delay(2000);

    // æ˜¾ç¤ºå½“å‰æ£‹ç›˜+å…‰æ ‡
    Cheat_Mode_UpdateDisplay(game_state);

    // é€šè¿‡åè®®é€šçŸ¥PC
    Protocol_SendDebugMessage("Cheat mode activated");
}

void Cheat_Mode_Exit(bool save_changes) {
    if (!cheat_ctx.initialized) {
        return;
    }

    if (!save_changes) {
        // æ¢å¤å¤‡ä»½
        // ï¼ˆéœ€è¦åœ¨è°ƒç”¨å¤„ä¼ é€’game_stateæŒ‡é’ˆï¼‰
    }

    cheat_ctx.state = CHEAT_MODE_INACTIVE;
    cheat_ctx.edit_count = 0;

    Protocol_SendDebugMessage(save_changes ? "Cheat mode saved" : "Cheat mode cancelled");
}

void Cheat_Mode_SetPiece(GameState_t* game_state, uint8_t row, uint8_t col, PieceType_t piece) {
    if (!game_state || row >= 8 || col >= 8) {
        return;
    }

    game_state->board[row][col] = piece;
    cheat_ctx.edit_count++;

    // é‡æ–°è®¡ç®—æ£‹å­æ•°é‡
    Othello_UpdatePieceCounts(game_state);

    // æ›´æ–°æ˜¾ç¤º
    Cheat_Mode_UpdateDisplay(game_state);
}

void Cheat_Mode_ClearPiece(GameState_t* game_state, uint8_t row, uint8_t col) {
    Cheat_Mode_SetPiece(game_state, row, col, PIECE_EMPTY);
}

void Cheat_Mode_MoveCursor(int8_t delta_row, int8_t delta_col) {
    int8_t new_row = cheat_ctx.cursor_row + delta_row;
    int8_t new_col = cheat_ctx.cursor_col + delta_col;

    // è¾¹ç•Œæ£€æŸ¥
    if (new_row >= 0 && new_row < 8) {
        cheat_ctx.cursor_row = new_row;
    }
    if (new_col >= 0 && new_col < 8) {
        cheat_ctx.cursor_col = new_col;
    }
}

void Cheat_Mode_HandleKey(Keypad_LogicalKey_t key, GameState_t* game_state) {
    if (cheat_ctx.state != CHEAT_MODE_ACTIVE) {
        return;
    }

    switch (key) {
        case KEY_2:  // ä¸Š
            Cheat_Mode_MoveCursor(-1, 0);
            break;
        case KEY_8:  // ä¸‹
            Cheat_Mode_MoveCursor(1, 0);
            break;
        case KEY_4:  // å·¦
            Cheat_Mode_MoveCursor(0, -1);
            break;
        case KEY_6:  // å³
            Cheat_Mode_MoveCursor(0, 1);
            break;
        case KEY_5:  // æ”¾ç½®æ£‹å­
            Cheat_Mode_SetPiece(game_state, cheat_ctx.cursor_row, cheat_ctx.cursor_col,
                               cheat_ctx.piece_to_place);
            break;
        case KEY_0:  // æ¸…é™¤æ£‹å­
            Cheat_Mode_ClearPiece(game_state, cheat_ctx.cursor_row, cheat_ctx.cursor_col);
            break;
        case KEY_7:  // åˆ‡æ¢é»‘æ£‹
            cheat_ctx.piece_to_place = PIECE_BLACK;
            break;
        case KEY_9:  // åˆ‡æ¢ç™½æ£‹
            cheat_ctx.piece_to_place = PIECE_WHITE;
            break;
        case KEY_STAR:  // å–æ¶ˆ
            Cheat_Mode_Exit(false);
            break;
        case KEY_HASH:  // ä¿å­˜
            Cheat_Mode_Exit(true);
            break;
        default:
            break;
    }

    // æ›´æ–°æ˜¾ç¤º
    Cheat_Mode_UpdateDisplay(game_state);
}

static void Cheat_Mode_UpdateDisplay(GameState_t* game_state) {
    // æ˜¾ç¤ºæ£‹ç›˜
    App_DisplayGameBoard();

    // é«˜äº®å…‰æ ‡ä½ç½®ï¼ˆé—ªçƒæ•ˆæœï¼‰
    uint32_t cursor_color = (cheat_ctx.piece_to_place == PIECE_BLACK) ?
                            WS2812B_COLOR_ORANGE : WS2812B_COLOR_WHITE;

    WS2812B_SetPixel(cheat_ctx.cursor_row, cheat_ctx.cursor_col, cursor_color);
    WS2812B_Update();
}

Cheat_Mode_State_t Cheat_Mode_GetState(void) {
    return cheat_ctx.state;
}
```

**ä¿®æ”¹main.c**:
```c
// åœ¨main.cä¸­é›†æˆ
#include "cheat_mode.h"

// åˆå§‹åŒ–
Cheat_Mode_Init();

// åœ¨æŒ‰é”®å¤„ç†ä¸­æ·»åŠ ä½œå¼Šæ¨¡å¼å…¥å£
// é•¿æŒ‰ 'C' (KEY_3) è¿›å…¥ä½œå¼Šæ¨¡å¼
if (long_press_detected && key == KEY_3) {
    Cheat_Mode_Enter(&game_state);
}

// åœ¨ä¸»å¾ªç¯ä¸­å¤„ç†ä½œå¼Šæ¨¡å¼æŒ‰é”®
if (Cheat_Mode_GetState() != CHEAT_MODE_INACTIVE) {
    Cheat_Mode_HandleKey(key, &game_state);
}
```

**æ–°å¢åè®®å‘½ä»¤** (uart_protocol.h):
```c
#define CMD_BOARD_EDIT  0x10   // æ£‹ç›˜ç¼–è¾‘å‘½ä»¤

// æ•°æ®æ ¼å¼
typedef struct {
    uint8_t row;
    uint8_t col;
    uint8_t piece_type;  // 0=EMPTY, 1=BLACK, 2=WHITE
} __attribute__((packed)) Board_Edit_Data_t;
```

**æ–°å¢æ–‡ä»¶**:
- `Core/Src/cheat_mode.c`
- `Core/Inc/cheat_mode.h`

**ä¿®æ”¹æ–‡ä»¶**:
- `Core/Src/main.c` (é›†æˆä½œå¼Šæ¨¡å¼)
- `Core/Inc/uart_protocol.h` (æ·»åŠ CMD_BOARD_EDIT)

---

#### ä»»åŠ¡2.2: ä¸Šä½æœºä½œå¼Šæ¨¡å¼å®ç°

**æ–°å¢æ–‡ä»¶**: `OthelloPC/gui/cheat_mode_panel.py`

è¯¦ç»†ä»£ç è§æ–‡æ¡£åç»­éƒ¨åˆ†ï¼ˆå®Œæ•´çš„CheatModePanelç±»å®ç°ï¼ŒåŒ…å«ï¼šæ£‹ç›˜ç¼–è¾‘UIã€å·¥å…·æ ã€ç»Ÿè®¡ä¿¡æ¯ã€ä¿å­˜/å–æ¶ˆ/é‡ç½®åŠŸèƒ½ï¼‰

**ä¿®æ”¹main_window.py** (æ·»åŠ ä½œå¼Šæ¨¡å¼å…¥å£):
```python
# åœ¨_create_menuæ–¹æ³•ä¸­æ·»åŠ 
game_menu.add_separator()
game_menu.add_command(label="ä½œå¼Šæ¨¡å¼ï¼ˆç¼–è¾‘æ£‹ç›˜ï¼‰", command=self._open_cheat_mode)

# æ·»åŠ æ–¹æ³•
def _open_cheat_mode(self):
    """æ‰“å¼€ä½œå¼Šæ¨¡å¼"""
    try:
        from gui.cheat_mode_panel import CheatModePanel

        # åˆ›å»ºä½œå¼Šæ¨¡å¼é¢æ¿
        cheat_panel = CheatModePanel(
            self.root,
            self.game_manager.current_game,
            self.serial_handler,
            on_save_callback=self._on_cheat_mode_saved
        )

    except Exception as e:
        self.logger.error(f"æ‰“å¼€ä½œå¼Šæ¨¡å¼å¤±è´¥: {e}")
        messagebox.showerror("é”™è¯¯", f"æ‰“å¼€ä½œå¼Šæ¨¡å¼å¤±è´¥:\n{e}")

def _on_cheat_mode_saved(self):
    """ä½œå¼Šæ¨¡å¼ä¿å­˜åçš„å›è°ƒ"""
    # æ›´æ–°æ£‹ç›˜æ˜¾ç¤º
    if self.game_board:
        self.game_board.update_board()

    # æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    self._update_status_display()

    self.logger.info("ä½œå¼Šæ¨¡å¼ä¿®æ”¹å·²åº”ç”¨")
```

**æ–°å¢æ–‡ä»¶**:
- `OthelloPC/gui/cheat_mode_panel.py`

**ä¿®æ”¹æ–‡ä»¶**:
- `OthelloPC/gui/main_window.py` (ç¬¬302-337è¡Œï¼Œèœå•æ éƒ¨åˆ†)
- `OthelloPC/communication/serial_handler.py` (æ·»åŠ CMD_BOARD_EDITæ”¯æŒ)

---

### ä¼˜å…ˆçº§3: å…¶ä»–ä¼˜åŒ–å’Œæ”¹è¿›

#### ä»»åŠ¡3.1: æ”¹å–„å†å²å›çœ‹å’Œæ’è¡Œæ¦œçš„å…¥å£å¯è§æ€§

**é—®é¢˜**: ç”¨æˆ·åæ˜ "éƒ½æ²¡æœ‰è§åˆ°"ï¼Œå¯èƒ½æ˜¯å…¥å£ä¸å¤Ÿæ˜æ˜¾

**ä¿®å¤æ–¹æ¡ˆ**:

1. **åœ¨æ§åˆ¶é¢æ¿æ·»åŠ å¿«æ·æŒ‰é’®** (control_panel.py):
```python
# åœ¨ControlPanelç±»çš„_create_uiæ–¹æ³•ä¸­æ·»åŠ 
quick_access_frame = tk.LabelFrame(
    main_frame,
    text="ğŸ“Š å¿«é€Ÿè®¿é—®",
    font=('Arial', 9, 'bold'),
    bg=DieterStyle.COLORS['panel_bg'],
    fg=DieterStyle.COLORS['gray_dark']
)
quick_access_frame.pack(fill='x', pady=(10, 0))

history_btn = DieterWidgets.create_button(
    quick_access_frame, "ğŸ“œ å†å²å›çœ‹",
    self.on_open_history,
    'secondary'
)
history_btn.pack(fill='x', padx=10, pady=(10, 5))

leaderboard_btn = DieterWidgets.create_button(
    quick_access_frame, "ğŸ† æ’è¡Œæ¦œ",
    self.on_open_leaderboard,
    'secondary'
)
leaderboard_btn.pack(fill='x', padx=10, pady=(5, 10))

# æ·»åŠ å›è°ƒå‚æ•°
def __init__(self, parent, serial_handler, on_state_change=None,
             on_mode_change=None, on_open_history=None, on_open_leaderboard=None):
    self.on_open_history = on_open_history
    self.on_open_leaderboard = on_open_leaderboard
    # ...
```

2. **åœ¨ä¸»çª—å£è¿æ¥å›è°ƒ**:
```python
# åœ¨main_window.pyçš„setup_uiæ–¹æ³•ä¸­
self.control_panel = ControlPanel(
    right_frame,
    self.serial_handler,
    on_state_change=self._on_game_control_state_changed,
    on_mode_change=self._on_game_mode_changed,
    on_open_history=self._open_history_viewer,  # æ–°å¢
    on_open_leaderboard=self._open_leaderboard  # æ–°å¢
)
```

**ä¿®æ”¹æ–‡ä»¶**:
- `OthelloPC/gui/control_panel.py` (æ·»åŠ å¿«æ·æŒ‰é’®)
- `OthelloPC/gui/main_window.py` (è¿æ¥å›è°ƒ)

---

#### ä»»åŠ¡3.2: å¢åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

**ç›®çš„**: æ–¹ä¾¿è°ƒè¯•é€šè®¯é—®é¢˜

**ä¿®å¤æ–¹æ¡ˆ**:

åœ¨`serial_handler.py`ä¸­å¢åŠ æ›´è¯¦ç»†çš„æ—¥å¿—ï¼ˆåŒ…æ‹¬æ•°æ®åŒ…åå…­è¿›åˆ¶æ˜¾ç¤ºã€å‘½ä»¤åç§°æ˜ å°„ã€ç¼“å†²åŒºçŠ¶æ€ç­‰ï¼‰

**ä¿®æ”¹æ–‡ä»¶**:
- `OthelloPC/communication/serial_handler.py` (_parse_received_dataæ–¹æ³•)

---

## ğŸ“ å®æ–½è®¡åˆ’æ—¶é—´è¡¨

### ç¬¬ä¸€é˜¶æ®µï¼šé€šè®¯ç¨³å®šæ€§ä¿®å¤ï¼ˆ1-2å¤©ï¼‰
- [ ] ä»»åŠ¡1.1: ä¿®å¤ä¸²å£å‚æ•°åº”ç”¨Bug (2å°æ—¶)
- [ ] ä»»åŠ¡1.2: å¢å¼ºè¿æ¥éªŒè¯æœºåˆ¶ (3å°æ—¶)
- [ ] ä»»åŠ¡1.3: ä¿®å¤ä¸‹ä½æœºçŠ¶æ€å›ä¼ é—®é¢˜ (4å°æ—¶)
- [ ] ä»»åŠ¡1.4: ä¼˜åŒ–èµ°æ£‹å»¶è¿Ÿ (3å°æ—¶)
- [ ] ä»»åŠ¡3.2: å¢åŠ è¯¦ç»†æ—¥å¿— (1å°æ—¶)

### ç¬¬äºŒé˜¶æ®µï¼šä½œå¼Šæ¨¡å¼å®ç°ï¼ˆ2-3å¤©ï¼‰
- [ ] ä»»åŠ¡2.1: ä¸‹ä½æœºä½œå¼Šæ¨¡å¼å®ç° (1å¤©)
  - [ ] åˆ›å»ºcheat_mode.c/hæ–‡ä»¶
  - [ ] å®ç°å…‰æ ‡ç§»åŠ¨å’Œæ£‹å­ç¼–è¾‘
  - [ ] é›†æˆåˆ°main.c
  - [ ] æ·»åŠ åè®®æ”¯æŒ
- [ ] ä»»åŠ¡2.2: ä¸Šä½æœºä½œå¼Šæ¨¡å¼å®ç° (1å¤©)
  - [ ] åˆ›å»ºcheat_mode_panel.py
  - [ ] å®ç°æ£‹ç›˜ç¼–è¾‘UI
  - [ ] é›†æˆåˆ°main_window.py
  - [ ] æµ‹è¯•ä¸Šä¸‹ä½æœºåŒæ­¥

### ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å’Œå®Œå–„ï¼ˆ1å¤©ï¼‰
- [ ] ä»»åŠ¡3.1: æ”¹å–„å…¥å£å¯è§æ€§ (2å°æ—¶)
- [ ] å…¨é¢æµ‹è¯• (4å°æ—¶)
- [ ] æ–‡æ¡£æ›´æ–° (2å°æ—¶)

**æ€»è®¡**: çº¦4-6å¤©å·¥ä½œé‡

---

## ğŸ§ª æµ‹è¯•éªŒè¯è®¡åˆ’

### é€šè®¯ç¨³å®šæ€§æµ‹è¯•
1. **å‹åŠ›æµ‹è¯•**:
   - å¿«é€Ÿè¿ç»­å‘é€100æ¬¡èµ°æ£‹å‘½ä»¤
   - éªŒè¯ï¼šæ‰€æœ‰å‘½ä»¤éƒ½æœ‰å“åº”ï¼Œå»¶è¿Ÿ<200ms

2. **é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•**:
   - ä¿æŒè¿æ¥30åˆ†é’Ÿ
   - æ¯5ç§’å‘é€ä¸€æ¬¡å‘½ä»¤
   - éªŒè¯ï¼šæ— æ–­çº¿ï¼Œæ— ä¸¢åŒ…

3. **å¼‚å¸¸æƒ…å†µæµ‹è¯•**:
   - æ‹”æ‰USBçº¿é‡æ–°æ’å…¥
   - STM32æ–­ç”µé‡å¯
   - éªŒè¯ï¼šä¸Šä½æœºèƒ½è‡ªåŠ¨æ¢å¤è¿æ¥

### ä¸²å£å‚æ•°æµ‹è¯•
1. è®¾ç½®æ•°æ®ä½ä¸º7ä½ï¼Œæµ‹è¯•é€šè®¯
2. è®¾ç½®åœæ­¢ä½ä¸º2ä½ï¼Œæµ‹è¯•é€šè®¯
3. è®¾ç½®æ ¡éªŒä½ä¸ºEvenï¼Œæµ‹è¯•é€šè®¯

### ä½œå¼Šæ¨¡å¼æµ‹è¯•
1. **ä¸‹ä½æœºæµ‹è¯•**:
   - é•¿æŒ‰'C'é”®è¿›å…¥ä½œå¼Šæ¨¡å¼
   - ä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨å…‰æ ‡
   - æŒ‰'5'æ”¾ç½®æ£‹å­
   - æŒ‰'#'ä¿å­˜ï¼ŒéªŒè¯æ£‹ç›˜çŠ¶æ€

2. **ä¸Šä½æœºæµ‹è¯•**:
   - ç‚¹å‡»èœå•è¿›å…¥ä½œå¼Šæ¨¡å¼
   - ç¼–è¾‘10ä¸ªä½ç½®
   - ä¿å­˜å¹¶éªŒè¯æ£‹ç›˜æ›´æ–°

3. **ä¸Šä¸‹ä½æœºåŒæ­¥æµ‹è¯•**:
   - ä¸Šä½æœºç¼–è¾‘åï¼Œä¸‹ä½æœºLEDæ˜¾ç¤ºæ˜¯å¦åŒæ­¥
   - ä¸‹ä½æœºç¼–è¾‘åï¼Œä¸Šä½æœºæ˜¯å¦æ¥æ”¶æ›´æ–°

---

## ğŸ“‚ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### æ–°å¢æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰
1. `Core/Src/cheat_mode.c` - ä¸‹ä½æœºä½œå¼Šæ¨¡å¼å®ç°
2. `Core/Inc/cheat_mode.h` - ä¸‹ä½æœºä½œå¼Šæ¨¡å¼å¤´æ–‡ä»¶
3. `OthelloPC/gui/cheat_mode_panel.py` - ä¸Šä½æœºä½œå¼Šæ¨¡å¼é¢æ¿

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ8ä¸ªï¼‰
1. `OthelloPC/communication/serial_handler.py` - ä¸²å£å‚æ•°ä¿®å¤ã€è¿æ¥éªŒè¯ã€æ—¥å¿—å¢å¼º
2. `OthelloPC/gui/main_window.py` - è¿æ¥éªŒè¯ä¼˜åŒ–ã€ä½œå¼Šæ¨¡å¼å…¥å£
3. `OthelloPC/gui/control_panel.py` - æ·»åŠ å¿«æ·æŒ‰é’®
4. `Core/Src/uart_protocol.c` - çŠ¶æ€å›ä¼ ä¼˜åŒ–ã€æ·»åŠ CMD_BOARD_EDITå¤„ç†
5. `Core/Inc/uart_protocol.h` - æ·»åŠ CMD_BOARD_EDITå®šä¹‰
6. `Core/Src/main.c` - é›†æˆä½œå¼Šæ¨¡å¼ã€ä¼˜åŒ–ä¸»å¾ªç¯
7. `Core/Inc/othello_engine.h` - å¯èƒ½éœ€è¦æ·»åŠ Othello_UpdatePieceCountså£°æ˜
8. `Core/Src/othello_engine.c` - å¯èƒ½éœ€è¦å®ç°Othello_UpdatePieceCounts

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é€šè®¯åè®®å…¼å®¹æ€§**:
   - æ·»åŠ CMD_BOARD_EDITåï¼Œä¸Šä¸‹ä½æœºåè®®ç‰ˆæœ¬å·åº”æ›´æ–°
   - å»ºè®®æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥æœºåˆ¶

2. **å†…å­˜ä½¿ç”¨**:
   - ä½œå¼Šæ¨¡å¼éœ€è¦å¤‡ä»½æ£‹ç›˜çŠ¶æ€ï¼Œç¡®ä¿STM32æœ‰è¶³å¤Ÿå†…å­˜
   - å½“å‰GameState_tçº¦136å­—èŠ‚ï¼Œå¤‡ä»½å¯æ¥å—

3. **ç”¨æˆ·ä½“éªŒ**:
   - ä½œå¼Šæ¨¡å¼åº”æœ‰æ˜æ˜¾çš„è§†è§‰æç¤ºï¼ˆLEDæ˜¾ç¤º"EDIT"ï¼‰
   - é€€å‡ºä½œå¼Šæ¨¡å¼æ—¶åº”ç¡®è®¤ä¿å­˜

4. **è°ƒè¯•æ–¹æ³•**:
   - ä½¿ç”¨é€»è¾‘åˆ†æä»ªç›‘æ§UARTä¿¡å·
   - å¯ç”¨è¯¦ç»†æ—¥å¿—æ¨¡å¼ï¼ˆè®¾ç½®loggingçº§åˆ«ä¸ºDEBUGï¼‰
   - ä½¿ç”¨LEDé—ªçƒæŒ‡ç¤ºå…³é”®äº‹ä»¶

5. **Gitæäº¤å»ºè®®**:
   - ä»»åŠ¡1ï¼ˆé€šè®¯ä¿®å¤ï¼‰ä½œä¸ºä¸€ä¸ªcommit
   - ä»»åŠ¡2.1ï¼ˆä¸‹ä½æœºä½œå¼Šï¼‰ä½œä¸ºä¸€ä¸ªcommit
   - ä»»åŠ¡2.2ï¼ˆä¸Šä½æœºä½œå¼Šï¼‰ä½œä¸ºä¸€ä¸ªcommit
   - ä»»åŠ¡3ï¼ˆä¼˜åŒ–ï¼‰ä½œä¸ºä¸€ä¸ªcommit

---

## ğŸ“– å‚è€ƒæ–‡æ¡£

- `docs/ç¡¬ä»¶è¿æ¥æŒ‡å—.md` - ç¡¬ä»¶è¿æ¥è¯´æ˜
- `docs/å¯åŠ¨æŒ‡å—.md` - é¡¹ç›®å¯åŠ¨æµç¨‹
- `docs/æŒ‰é”®æ“ä½œæŒ‡å—.md` - æŒ‰é”®æ˜ å°„è¯´æ˜
- `CLAUDE.md` - é¡¹ç›®å¼€å‘è§„èŒƒ

---

## ğŸ‰ å®Œæˆæ ‡å‡†

### é€šè®¯ç¨³å®šæ€§
- âœ… è¿æ¥æˆåŠŸç‡ > 95%
- âœ… å‘½ä»¤å“åº”å»¶è¿Ÿ < 200ms
- âœ… 30åˆ†é’Ÿæ— æ–­çº¿æ— ä¸¢åŒ…

### ä¸²å£å‚æ•°
- âœ… æ‰€æœ‰å‚æ•°ï¼ˆç«¯å£ã€æ³¢ç‰¹ç‡ã€æ•°æ®ä½ã€åœæ­¢ä½ã€æ ¡éªŒä½ï¼‰éƒ½èƒ½æ­£å¸¸åº”ç”¨
- âœ… å‚æ•°ä¿®æ”¹åèƒ½æˆåŠŸè¿æ¥

### ä½œå¼Šæ¨¡å¼
- âœ… ä¸Šä½æœºèƒ½ç¼–è¾‘æ£‹ç›˜å¹¶åŒæ­¥åˆ°ä¸‹ä½æœº
- âœ… ä¸‹ä½æœºèƒ½ä½¿ç”¨æŒ‰é”®ç¼–è¾‘æ£‹ç›˜
- âœ… ç¼–è¾‘åçš„æ£‹ç›˜çŠ¶æ€æ­£ç¡®æ˜¾ç¤ºå’Œä¿å­˜

### ç”¨æˆ·ä½“éªŒ
- âœ… å†å²å›çœ‹å’Œæ’è¡Œæ¦œå…¥å£æ˜æ˜¾ï¼Œç”¨æˆ·èƒ½è½»æ¾æ‰¾åˆ°
- âœ… æ‰€æœ‰åŠŸèƒ½æœ‰æ¸…æ™°çš„æ“ä½œè¯´æ˜
- âœ… æ— éœ€é¢‘ç¹é‡å¯

---

**è®¡åˆ’åˆ¶å®šäºº**: Claude Sonnet 4.5
**å®¡æ ¸æ—¥æœŸ**: å¾…ç”¨æˆ·ç¡®è®¤
**å¼€å§‹å®æ–½æ—¥æœŸ**: ç”¨æˆ·åŒæ„åç«‹å³å¼€å§‹
