# 黑白棋游戏 - 按键操作指南

## 版本：v1.0 (Production Release)
## 更新日期：2025-12-03

---

## 一、硬件布局

### 1.1 4×4矩阵键盘布局

您的键盘按照标准十六进制键盘布局排列：

```
┌─────┬─────┬─────┬─────┐
│  1  │  2  │  3  │  A  │  ← 第0行
├─────┼─────┼─────┼─────┤
│  4  │  5  │  6  │  B  │  ← 第1行
├─────┼─────┼─────┼─────┤
│  7  │  8  │  9  │  C  │  ← 第2行
├─────┼─────┼─────┼─────┤
│  *  │  0  │  #  │  D  │  ← 第3行
└─────┴─────┴─────┴─────┘
  ↑     ↑     ↑     ↑
 列0   列1   列2   列3
```

### 1.2 8×8 LED矩阵布局

LED矩阵对应棋盘坐标：

```
   列0  列1  列2  列3  列4  列5  列6  列7
行0 [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]
行1 [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]
行2 [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]
行3 [ ]  [ ]  [🟠]  [⚪]  [ ]  [ ]  [ ]  [ ]  ← 初始位置
行4 [ ]  [ ]  [⚪]  [🟠]  [ ]  [ ]  [ ]  [ ]  ← 初始位置
行5 [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]
行6 [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]
行7 [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]  [ ]

图例：🟠 = 黑子（橙色）  ⚪ = 白子  [ ] = 空位  🟢 = 光标
```

---

## 二、当前按键功能（v0.2.0）

### 2.1 按键功能映射表

```
╔═══════╦═══════╦═══════╦═══════╗
║   1   ║   2↑  ║   3   ║   A   ║
║新游戏  ║  上   ║ (预留) ║ (预留) ║
╠═══════╬═══════╬═══════╬═══════╣
║   4←  ║   5   ║   6→  ║   B   ║
║  左   ║ 落子  ║  右   ║ (预留) ║
╠═══════╬═══════╬═══════╬═══════╣
║   7   ║   8↓  ║   9   ║   C   ║
║(预留)  ║  下   ║ 发送  ║ (预留) ║
╠═══════╬═══════╬═══════╬═══════╣
║   *   ║   0   ║   #   ║   D   ║
║(预留)  ║ 重置  ║ (预留) ║ (预留) ║
╚═══════╩═══════╩═══════╩═══════╝
```

| 按键 | 功能 | 说明 | 状态 |
|:---:|:---|:---|:---:|
| **1** | 新游戏 | 重新开始游戏，清空棋盘并重置为初始状态 | ✅ 已实现 |
| **2** | 向上 | 光标向上移动一格 | ✅ 已实现 |
| **4** | 向左 | 光标向左移动一格 | ✅ 已实现 |
| **5** | 落子 | 在当前光标位置落子（如果合法） | ✅ 已实现 |
| **6** | 向右 | 光标向右移动一格 | ✅ 已实现 |
| **8** | 向下 | 光标向下移动一格 | ✅ 已实现 |
| **0** | 重置 | 重置游戏（与按键1功能相同） | ✅ 已实现 |
| **9** | 发送 | 发送棋盘状态到上位机 | ✅ 已实现 |
| **3** | (预留) | 未来扩展功能 | ⏳ 预留 |
| **7** | (预留) | 未来扩展功能 | ⏳ 预留 |
| ***** | (预留) | 未来扩展功能（建议：菜单） | ⏳ 预留 |
| **#** | (预留) | 未来扩展功能（建议：确认） | ⏳ 预留 |
| **A** | (预留) | 未来扩展功能 | ⏳ 预留 |
| **B** | (预留) | 未来扩展功能（建议：回放） | ⏳ 预留 |
| **C** | (预留) | 未来扩展功能 | ⏳ 预留 |
| **D** | (预留) | 未来扩展功能 | ⏳ 预留 |

---

## 三、光标移动系统（NEW！）

### 3.1 光标显示

- **颜色**: 绿色 LED
- **闪烁**: 每500ms闪烁一次
- **初始位置**: 棋盘中心 (3,3)
- **显示规则**:
  - 空位：显示绿色光标
  - 有棋子：不显示光标（避免遮挡棋子）

### 3.2 移动方式

使用方向键（2/4/6/8）控制光标：

```
         ↑ (2)
         │
    ← (4)┼ (6) →
         │
         ↓ (8)
```

**移动特性**：
- 边界检查：光标不会移出8×8棋盘范围
- 移动时立即显示光标（停止闪烁）
- 移动后重置闪烁计时器

### 3.3 落子流程

1. 使用方向键移动光标到目标位置
2. 按下按键 **5** 确认落子
3. 系统检查是否合法：
   - ✅ **合法**: 放置棋子 → 翻转对手棋子 → 切换玩家
   - ❌ **非法**: LED红色闪烁提示 → 光标位置不变

---

## 四、颜色说明

### 4.1 LED颜色含义

| 颜色 | RGB值 | 含义 | 显示位置 |
|:---:|:---:|:---|:---|
| **橙色** | (255, 102, 0) | 黑方棋子 | 棋盘 |
| **白色** | (255, 255, 255) | 白方棋子 | 棋盘 |
| **绿色** | (0, 255, 0) | 光标位置 | 当前光标 |
| **红色** | (255, 0, 0) | 非法提示 | 无效操作 |
| **关闭** | (0, 0, 0) | 空位 | 无棋子位置 |

### 4.2 上下位机颜色统一

- **下位机（STM32）**: 黑子显示为橙色 LED
- **上位机（PC）**: 黑子显示为橙色圆圈
- **设计理念**: 博朗橙色，来自迪特·拉姆斯设计风格

---

## 五、完整操作流程

### 5.1 游戏开始

```
1. 系统上电
   ↓
2. LED矩阵显示初始棋盘（中心4颗棋子）
   - (3,3) = 橙色（黑子）
   - (3,4) = 白色（白子）
   - (4,3) = 白色（白子）
   - (4,4) = 橙色（黑子）
   ↓
3. 光标出现在 (3,3) 位置（绿色闪烁）
   ↓
4. 黑方先手，等待玩家操作
```

### 5.2 标准下棋流程

```
[开始]
  ↓
[使用 2/4/6/8 移动光标]
  ↓
[光标移动到目标位置]
  ↓
[按下 5 确认落子]
  ↓
┌─────────────┐
│ 检查合法性  │
└─────────────┘
  ↓
┌──────┴──────┐
│合法         │非法
↓             ↓
放置棋子      红色闪烁
翻转对手      (200ms)
切换玩家      ↓
↓             恢复显示
更新LED显示   ↓
↓             返回开始
发送到PC
↓
检查游戏结束？
  ↓
  Yes: 游戏结束 → 统计输出 → PC弹出AI分析选择
  No: 返回开始
```

### 5.3 特殊操作

#### 新游戏（按键1）
```
按下按键1
  ↓
保存当前游戏统计
  ↓
清空棋盘
  ↓
放置初始4颗棋子
  ↓
光标重置到 (3,3)
  ↓
黑方先手
```

#### 重置游戏（按键0）
```
按下按键0
  ↓
与按键1功能相同
```

#### 发送状态（按键9）
```
按下按键9
  ↓
通过串口发送当前棋盘状态到PC
  ↓
PC上位机同步显示
```

---

## 六、游戏结束处理

### 6.1 游戏结束条件

- 棋盘下满（64颗棋子）
- 双方都无法落子

### 6.2 游戏结束流程

```
[检测到游戏结束]
  ↓
[串口输出游戏历史]
  - 总回合数
  - 最后一步走法
  - 黑白棋子数量
  - 胜负结果
  ↓
[发送状态到PC]
  ↓
[PC弹出对话框]
  "游戏结束！黑方（橙色）获胜！

   是否使用DeepSeek AI分析这局游戏？"
  ↓
┌───────┴───────┐
│是            │否
↓              ↓
调用AI分析     关闭对话框
显示分析报告
```

### 6.3 AI分析功能

- **触发时机**: 游戏结束后，用户选择
- **适用模式**: 人类vs人类 / 人机对战 均可
- **分析内容**: DeepSeek AI分析整局走法，提供改进建议
- **成本控制**: 仅在用户确认后调用API

---

## 七、串口调试日志

### 7.1 日志等级

连接串口（115200波特率），可以看到以下调试信息：

#### 系统启动
```
[INIT] WS2812B Driver...OK
[INIT] Keypad Driver...OK
[INIT] Othello Engine...OK
[BOOT] System Ready!
```

#### 按键检测
```
[APP] ProcessKey: R1 C1 Logical=5 State=1
[APP] Place piece at cursor (3,4)
[APP] Move SUCCESS: flipped 2 pieces
```

#### 光标移动
```
[APP] Cursor RIGHT: (3,4)
[APP] Cursor DOWN: (4,4)
```

#### 游戏历史（游戏结束时输出）
```
========== Game History ==========
Total moves: 28
Black count: 35, White count: 29
Game status: 1

Last move:
  Player: 1, Position: (5,3), Flipped: 4

Game Result:
  Winner: BLACK (Orange)
==================================
```

---

## 八、上位机状态显示

### 8.1 棋盘格样式状态面板

PC上位机显示2×2网格状态面板：

```
┌──────────────┬──────────────┐
│  当前回合    │  STM32状态   │
│ 黑方（橙色）▶│  ● 已连接    │
├──────────────┼──────────────┤
│  棋子统计    │ ⌨️ 下位机按键 │
│ 橙:2 vs 白:2 │ 2↑ 4← 5● 6→8↓│
└──────────────┴──────────────┘
```

### 8.2 状态更新时机

- 每次落子后
- 串口接收到STM32状态更新
- 连接/断开STM32
- 游戏结束

---

## 九、常见问题排查

### 9.1 光标不显示

**症状**: 按方向键后光标不显示

**排查步骤**:
1. 检查串口输出是否有 `[APP] Cursor XXX` 日志
   - 有日志：光标移动成功，检查LED显示
   - 无日志：按键未识别，检查硬件连接

2. 检查光标位置是否有棋子
   - 有棋子：光标不显示（设计如此）
   - 空位：应该显示绿色LED

### 9.2 按键无响应

**症状**: 按键按下，LED没有反应

**排查步骤**:
1. 检查串口输出是否有 `[APP] ProcessKey` 日志
2. 检查按键连接（R1-R4: PB12-15, C1-C4: PB5-8）
3. 重启STM32

### 9.3 落子非法提示

**症状**: 明明看起来可以落子，却显示红色

**可能原因**:
1. 该位置无法翻转任何对手棋子（黑白棋规则）
2. 光标位置已有棋子
3. 不是当前玩家的回合

---

## 十、版本更新历史

### v1.0 (2025-12-03) - Production Release 🎉
**新增功能**:
- ✅ 光标移动系统完全正常（2/4/6/8方向键）
- ✅ 绿色闪烁光标指示
- ✅ 黑子改为橙色显示（上下位机统一）
- ✅ 游戏结束后输出历史统计
- ✅ 上位机棋盘格样式状态面板
- ✅ AI分析选择对话框
- ✅ LED坐标映射完全正确（标准线性布线）
- ✅ 按键响应优化（10ms debounce）

**改进**:
- 🔧 修复按键去抖逻辑bug（移除stable_count机制）
- 🔧 修复LED坐标映射错误（确认为简单线性映射）
- 🔧 优化按键处理逻辑
- 🔧 增强Debug日志输出
- 🔧 改进状态显示
- 🔧 清理所有诊断debug代码

**验证通过**:
- ✅ 光标移动完全正确
- ✅ 落子功能完全正常
- ✅ LED显示准确无偏移
- ✅ 按键响应及时稳定
- ✅ 游戏逻辑完全正确

### v0.2.0 (2025-12-03) - Debug Version
**新增功能**:
- ✅ 光标移动系统（2/4/6/8方向键）
- ✅ 绿色闪烁光标指示
- ✅ 黑子改为橙色显示（上下位机统一）
- ✅ 游戏结束后输出历史统计
- ✅ 上位机棋盘格样式状态面板
- ✅ AI分析选择对话框

**改进**:
- 🔧 优化按键处理逻辑
- 🔧 增强Debug日志输出
- 🔧 改进状态显示

**已知问题**:
- ⚠️ 按键去抖有bug，需要修复
- ⚠️ LED坐标映射错误，需要诊断

### v0.1.0 (2025-11-28) - 基础功能
- ✅ 基本黑白棋游戏逻辑
- ✅ LED矩阵显示
- ✅ 按键1/0/5/9功能
- ✅ 串口通信

---

## 十一、快速参考卡片

### 常用按键速查

| 操作 | 按键组合 | 说明 |
|:---|:---:|:---|
| 移动光标 | 2/4/6/8 | 上/左/右/下 |
| 确认落子 | 5 | 在光标位置落子 |
| 新游戏 | 1 | 重新开始 |
| 重置 | 0 | 同新游戏 |
| 同步到PC | 9 | 发送状态 |

### 颜色速查

| 颜色 | 含义 |
|:---:|:---|
| 🟠 橙色 | 黑方棋子 |
| ⚪ 白色 | 白方棋子 |
| 🟢 绿色 | 光标位置 |
| 🔴 红色 | 非法操作 |

---

**文档版本**：3.0
**最后更新**：2025-12-03
**状态**：Production Release - 所有功能验证通过 ✅
**维护者**：Claude Code
**联系方式**：项目GitHub仓库

---

## 二、当前实现的按键功能

### 2.1 按键功能映射表

| 按键 | 功能 | 说明 |
|:---:|:---|:---|
| **1** | 新游戏 | 重新开始游戏，清空棋盘并重置为初始状态 |
| **5** | 落子 | 在当前按键对应位置落子（如果合法） |
| **0** | 重置 | 重置游戏（与按键1功能相同） |
| **9** | 发送棋盘状态 | （调试模式下不可用，生产模式发送给PC） |
| **其他** | 位置标记 | 按下时LED显示绿色，释放后恢复 |

### 2.2 功能键详细说明

#### 按键 1 - 新游戏
```
功能：开始新一局游戏
效果：
  - 清空棋盘
  - 在中心放置初始4颗棋子
  - 黑方先手
  - LED显示更新
```

#### 按键 5 - 落子（重要）
```
功能：在按键对应的棋盘位置落子
逻辑：
  1. 检查当前位置是否为空
  2. 检查是否能翻转对手棋子（黑白棋规则）
  3. 如果合法：
     - 放置己方棋子
     - 翻转所有能翻转的对手棋子
     - 切换到对手回合
     - LED显示更新
  4. 如果非法：
     - LED闪烁红色提示
     - 不执行落子

注意：目前按键5的位置对应棋盘(1, 1)位置
```

#### 按键 0 - 重置游戏
```
功能：重置游戏状态
效果：与按键1相同
```

---

## 三、当前操作流程（v0.1.0调试版本）

### 3.1 系统启动流程

1. **上电启动**
   ```
   - STM32初始化
   - LED矩阵显示测试（第一颗LED亮红色）
   - 串口输出：[BOOT] System Ready!
   ```

2. **初始棋盘**
   ```
   - 棋盘中心4颗棋子就绪
   - LED显示初始局面
   - 黑方先手
   ```

### 3.2 下棋流程（当前版本的限制）

**重要提示**：当前v0.1.0版本的落子功能有限制，因为4×4键盘无法直接对应8×8棋盘的所有位置。

#### 当前可用的落子方式

**方式1：使用按键5落子**
```
步骤：
1. 按下按键5
2. 系统尝试在按键5对应的棋盘位置(1,1)落子
3. 如果位置合法且能翻转棋子，则落子成功
4. 如果非法，LED闪烁红色

限制：只能在按键5对应的位置落子
```

**方式2：按键位置映射（调试功能）**
```
当前实现（参见 main.c 第522-582行）：
- 按下任意按键：对应LED位置显示绿色
- 按键释放：恢复正常显示

这个功能主要用于调试，验证按键和LED的对应关系
```

### 3.3 当前游戏逻辑流程图

```
[系统启动]
    ↓
[显示初始棋盘：中心4颗棋子]
    ↓
[等待玩家按键]
    ↓
[检测到按键]
    ↓
┌─────────────────────┐
│ 按键类型判断        │
└─────────────────────┘
         ↓
    ┌────┴────┐
    │         │
按键1/0      按键5              其他按键
    │         │                    │
 新游戏    尝试落子            显示绿色标记
    │         │                    │
    │    ┌────┴────┐              │
    │    │         │              │
    │  合法     非法              │
    │    │         │              │
    │  落子    红色提示           │
    │  翻转                        │
    │  切换                        │
    │    │                         │
    └────┴─────────────────────────┘
         ↓
   [更新LED显示]
         ↓
   [返回等待按键]
```

---

## 四、预期的完整操作方式（未来版本）

### 4.1 规划中的操作模式

**模式A：方向键 + 确认键**
```
按键2/4/6/8：移动光标
按键5：确认落子
按键*：菜单
按键#：确认
按键0：返回
```

**模式B：数字坐标输入**
```
按两次数字键输入坐标
例如：按"3"→"5" 表示在(3,5)位置落子
按键5或#：确认
按键0或*：取消
```

### 4.2 游戏状态指示（规划中）

```
- LED颜色区分：
  ⚫ 黑子：低亮度白色或关闭
  ⚪ 白子：高亮度白色
  🟢 光标：绿色闪烁
  🔴 非法提示：红色闪烁
  🔵 可落子位置：蓝色低亮度（可选）
```

---

## 五、调试模式下的串口输出

### 5.1 查看游戏状态

连接串口（115200波特率），可以看到以下调试信息：

```
【系统启动】
[INIT] WS2812B Driver...OK
[INIT] Keypad Driver...OK
[INIT] Othello Engine...OK
[BOOT] System Ready!

【按键检测】
[KEY] Detected: R1 C1 State=1    ← 按键5按下
[APP] KeyEvent: R1 C1 State=1 Logical=5
[APP] ProcessKey: R1 C1 Logical=5

【心跳日志】
[HEARTBEAT] tick=1000
[HEARTBEAT] tick=2000
...
```

### 5.2 判断落子是否成功

通过串口日志可以判断：
- 如果看到 `[APP] ProcessKey` 且没有错误，说明按键被识别
- 如果LED显示更新，说明落子成功
- 如果LED闪红色，说明落子位置非法

---

## 六、黑白棋规则快速参考

### 6.1 基本规则

1. **落子条件**：必须能翻转至少一颗对手的棋子
2. **翻转方向**：横、竖、斜8个方向
3. **无法落子**：如果当前玩家无处可落，跳过回合
4. **游戏结束**：双方都无法落子，或棋盘下满

### 6.2 翻转示例

```
落子前：
[ ]  [ ]  [ ]
[⚫] [⚪] [ ]  ← 黑方在(0,2)落子
[ ]  [ ]  [ ]

落子后：
[ ]  [ ]  [⚫]  ← 新落的黑子
[⚫] [⚫] [ ]   ← 白子被翻转为黑子
[ ]  [ ]  [ ]
```

### 6.3 合法落子判断

必须满足以下条件：
1. 位置为空
2. 至少一个方向上：
   - 相邻是对手的棋子
   - 沿该方向继续，能找到己方棋子
   - 中间全是对手棋子

---

## 七、常见问题排查

### 7.1 按键无响应

**症状**：按键按下，LED没有反应

**排查步骤**：
1. 检查串口输出是否有 `[KEY] Detected` 日志
   - 有日志：按键驱动正常，检查游戏逻辑
   - 无日志：按键驱动问题，检查硬件连接

2. 检查硬件连接
   ```
   行线(R1-R4): PB12, PB13, PB14, PB15
   列线(C1-C4): PB5, PB6, PB7, PB8
   ```

### 7.2 LED显示异常

**症状1**：LED完全不亮
- 检查串口是否有 `[LED] DMA Complete` 日志
- 检查PA0数据线连接
- 检查WS2812B供电（5V）

**症状2**：LED显示错误颜色
- 正常：黑子和白子颜色区分清晰
- 异常：检查WS2812B_COLOR_BLACK 和 WS2812B_COLOR_WHITE 定义

**症状3**：LED闪烁或花屏
- 可能是信号质量问题
- 添加470Ω电阻或电平转换（3.3V→5V）

### 7.3 落子规则问题

**症状**：合法位置显示红色（无法落子）

**原因**：
1. 当前版本只有按键5能触发落子逻辑
2. 其他按键只会显示位置标记
3. 需要实现完整的坐标映射系统

---

## 八、下一步开发计划

### 8.1 急需实现的功能

1. **完整的坐标输入系统**
   - 实现按键到棋盘位置的映射
   - 添加光标移动功能
   - 显示当前选中位置

2. **游戏状态显示**
   - 显示当前执棋方
   - 显示可落子位置提示
   - 显示黑白双方棋子数量

3. **上下位机通信**
   - 恢复UART Protocol功能
   - 实现PC端控制
   - 实现AI分析功能

### 8.2 优化项

1. LED显示效果优化
2. 按键防误触处理
3. 添加音效提示（可选）
4. 实现悔棋功能

---

## 九、快速测试步骤

### 测试1：系统基本功能
```
1. 上电
2. 观察串口输出是否正常
3. 观察LED是否显示初始棋盘（中心4颗棋子）
4. 按下任意按键，观察是否有绿色标记
```

### 测试2：新游戏功能
```
1. 按下按键1
2. 观察LED是否重新显示初始状态
3. 串口应输出相关日志
```

### 测试3：落子功能（有限）
```
1. 确认当前棋盘状态
2. 按下按键5
3. 观察LED是否更新
4. 检查串口日志
```

---

## 十、技术支持

### 相关文档
- [硬件连接指南](./硬件连接指南.md)
- [启动指南](./启动指南.md)
- [Debug调试日志](./debug日志.md)
- [CLAUDE.md](../CLAUDE.md) - 开发规范

### 串口调试
- 波特率：115200
- 数据位：8
- 停止位：1
- 校验：无
- 连接：PA9(TX), PA10(RX)

---

**文档版本**：1.0
**最后更新**：2025-12-03
**状态**：调试模式，功能受限
**维护者**：Claude Code
