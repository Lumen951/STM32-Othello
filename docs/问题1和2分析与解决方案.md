# STM32 Othello å¯ä¸‹ä½ç½®ä¸åŒ¹é…å’Œæ¨¡å¼ä¸åŒæ­¥é—®é¢˜åˆ†æ

**æ–‡æ¡£åˆ›å»ºæ—¥æœŸ**: 2025-12-17
**é—®é¢˜åé¦ˆ**: ç”¨æˆ·
**çŠ¶æ€**: é—®é¢˜åˆ†æä¸­

---

## ğŸ”´ é—®é¢˜1: å¯ä¸‹ä½ç½®æŒ‡ç¤ºä¸åŒ¹é…

### é—®é¢˜æè¿°
- **ç”¨æˆ·åé¦ˆ**: ä¸Šä½æœºæŒ‡ç¤ºçš„å¯ä¸‹ä½ç½®å’Œä¸‹ä½æœºå¯¹ä¸ä¸Š
- **å¯èƒ½åŸå› **: å½“å‰ç©å®¶ä¸åŒæ­¥å¯¼è‡´è®¡ç®—çš„æœ‰æ•ˆèµ°æ³•ä¸ä¸€è‡´

### ä»£ç åˆ†æ

#### ä¸Šä½æœºå¯ä¸‹ä½ç½®æ˜¾ç¤ºé€»è¾‘ (`game_board.py:191-203`)
```python
def _draw_valid_moves(self):
    """ç»˜åˆ¶æœ‰æ•ˆèµ°æ³•æç¤º"""
    valid_moves = self.game_state.get_valid_moves(self.game_state.current_player)  # âš ï¸ ä½¿ç”¨current_player

    for row, col in valid_moves:
        x = col * self.cell_size + self.cell_size // 2
        y = row * self.cell_size + self.cell_size // 2

        # ç»˜åˆ¶å°åœ†ç‚¹æç¤º
        self.canvas.create_oval(
            x - 6, y - 6, x + 6, y + 6,
            fill=self.colors['valid_move'],
            outline=self.colors['valid_move'],
            tags='valid_move'
        )
```

**å…³é”®å‘ç°**: ä¸Šä½æœºåŸºäº `game_state.current_player` è®¡ç®—å¯ä¸‹ä½ç½®

#### æ£‹ç›˜çŠ¶æ€åŒæ­¥é€»è¾‘ (`game_state.py:290-303`)
```python
def update_board_state(self, board_data: bytes):
    """ä»STM32æ›´æ–°æ£‹ç›˜çŠ¶æ€"""
    # è§£æSTM32å‘é€çš„æ£‹ç›˜æ•°æ®
    # å‡è®¾æ•°æ®æ ¼å¼: 64å­—èŠ‚è¡¨ç¤º8x8æ£‹ç›˜çŠ¶æ€
    if len(board_data) >= 64:
        for i in range(64):
            row = i // 8
            col = i % 8
            piece_value = board_data[i]
            self.current_game.board[row][col] = PieceType(piece_value)  # âœ… æ›´æ–°æ£‹ç›˜

        # æ›´æ–°è®¡æ•°
        self.current_game._update_piece_counts()  # âœ… æ›´æ–°è®¡æ•°
        self._notify_observers('board_updated')   # âœ… é€šçŸ¥æ›´æ–°
```

**é—®é¢˜æ ¹æº**:
âŒ **åªæ›´æ–°äº†æ£‹ç›˜æ•°æ®ï¼Œæ²¡æœ‰æ›´æ–° `current_player`ï¼**

#### ä¸‹ä½æœºå‘é€çš„å®Œæ•´æ•°æ® (`uart_protocol.h:114-121`)
```c
typedef struct {
    uint8_t board[8][8];        // 64 bytes - æ£‹ç›˜
    uint8_t current_player;     // 1 byte  - å½“å‰ç©å®¶ âš ï¸ è¢«å¿½ç•¥ï¼
    uint8_t black_count;        // 1 byte  - é»‘æ£‹æ•°é‡
    uint8_t white_count;        // 1 byte  - ç™½æ£‹æ•°é‡
    uint8_t game_over;          // 1 byte  - æ¸¸æˆç»“æŸæ ‡å¿—
    uint32_t move_count;        // 4 bytes - èµ°æ³•è®¡æ•°
} Game_State_Data_t;
// æ€»å…± 72 bytes
```

### é—®é¢˜æ¼”ç¤ºåœºæ™¯

1. **åˆå§‹çŠ¶æ€**: é»‘æ£‹å…ˆæ‰‹
   - ä¸‹ä½æœº `current_player = 1` (BLACK)
   - ä¸Šä½æœº `current_player = 1` (BLACK)
   - âœ… å¯ä¸‹ä½ç½®ä¸€è‡´

2. **ä¸‹ä½æœºä¸‹æ£‹å**:
   - ä¸‹ä½æœºæ‰§è¡Œèµ°æ£‹ï¼Œåˆ‡æ¢åˆ°ç™½æ£‹ `current_player = 2` (WHITE)
   - ä¸‹ä½æœºå‘é€72å­—èŠ‚æ•°æ®ï¼ˆåŒ…å« `current_player = 2`ï¼‰
   - ä¸Šä½æœºæ¥æ”¶æ•°æ®ï¼Œ**åªè¯»å–å‰64å­—èŠ‚ï¼ˆæ£‹ç›˜ï¼‰**
   - ä¸Šä½æœº `current_player` **ä»ç„¶æ˜¯1** (BLACK) âŒ
   - ç»“æœï¼šä¸Šä½æœºè®¡ç®—çš„æ˜¯é»‘æ£‹çš„å¯ä¸‹ä½ç½®ï¼Œä½†å®é™…åº”è¯¥æ˜¯ç™½æ£‹ï¼

---

## ğŸ”´ é—®é¢˜2: æ¸¸æˆæ¨¡å¼ä¸åŒæ­¥

### é—®é¢˜æè¿°
- **ç”¨æˆ·åé¦ˆ**: ä¸Šä½æœºæ²¡æœ‰åŒæ­¥ä¸‹ä½æœºçš„æ¸¸æˆæ¨¡å¼ï¼Œæ°¸è¿œéƒ½æ˜¯åŒäººå¯¹å±€çš„æ™®é€šæ¨¡å¼

### ä»£ç åˆ†æ

#### ä¸Šä½æœºæ˜¯å¦å¤„ç†CMD_MODE_SELECTï¼Ÿ

æŸ¥æ‰¾ç»“æœï¼š**æ²¡æœ‰å¤„ç† CMD_MODE_SELECT (0x0D)**

`main.py:95-176` ä¸­çš„ `on_serial_data_received()` æ–¹æ³•ï¼š
- âœ… å¤„ç† CMD_BOARD_STATE (0x01)
- âœ… å¤„ç† CMD_ACK (0x08)
- âœ… å¤„ç† CMD_KEY_EVENT (0x0A)
- âœ… å¤„ç† CMD_SYSTEM_INFO (0x05)
- âœ… å¤„ç† CMD_HEARTBEAT (0x07)
- âœ… å¤„ç† CMD_GAME_CONFIG (0x03)
- âŒ **æ²¡æœ‰å¤„ç† CMD_MODE_SELECT (0x0D)**

#### ä¸‹ä½æœºæ˜¯å¦å‘é€æ¨¡å¼ä¿¡æ¯ï¼Ÿ

æŸ¥æ‰¾ç»“æœï¼š**ä¸‹ä½æœºæœ‰å¤„ç†CMD_MODE_SELECTï¼Œä½†å¯èƒ½æ²¡æœ‰ä¸»åŠ¨é€šçŸ¥ä¸Šä½æœº**

#### æ¨¡å¼å­˜å‚¨ä½ç½®

ä¸Šä½æœºå¯èƒ½æœ‰è‡ªå·±çš„æ¨¡å¼ç®¡ç†ï¼Œéœ€è¦æ£€æŸ¥ï¼š
- `control_panel.py` ä¸­çš„æ¨¡å¼é€‰æ‹©
- `main_window.py` ä¸­çš„æ¨¡å¼çŠ¶æ€
- `challenge_mode.py` å’Œ `timed_mode.py` çš„æ¿€æ´»

---

## âœ… è§£å†³æ–¹æ¡ˆ

### è§£å†³æ–¹æ¡ˆ1: ä¿®å¤å½“å‰ç©å®¶åŒæ­¥ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `OthelloPC/game/game_state.py` (ç¬¬290-310è¡Œ)

```python
def update_board_state(self, board_data: bytes):
    """ä»STM32æ›´æ–°å®Œæ•´æ¸¸æˆçŠ¶æ€"""
    import struct
    import logging
    logger = logging.getLogger(__name__)

    # æ£€æŸ¥æ•°æ®é•¿åº¦ï¼ˆGame_State_Data_t = 72 bytesï¼‰
    if len(board_data) < 72:
        logger.error(f"âŒ æ¸¸æˆçŠ¶æ€æ•°æ®ä¸å®Œæ•´: æ¥æ”¶{len(board_data)}å­—èŠ‚, æœŸæœ›72å­—èŠ‚")
        return

    try:
        # ========== 1. è§£ææ£‹ç›˜æ•°æ® (0-63å­—èŠ‚) ==========
        for i in range(64):
            row = i // 8
            col = i % 8
            piece_value = board_data[i]
            self.current_game.board[row][col] = PieceType(piece_value)

        # ========== 2. è§£æå½“å‰ç©å®¶ (64å­—èŠ‚) âš ï¸ å…³é”®ä¿®å¤ ==========
        current_player_value = board_data[64]
        old_player = self.current_game.current_player
        self.current_game.current_player = PieceType(current_player_value)

        # ========== 3. è§£ææ£‹å­è®¡æ•° (65-66å­—èŠ‚) ==========
        self.current_game.black_count = board_data[65]
        self.current_game.white_count = board_data[66]

        # ========== 4. è§£ææ¸¸æˆç»“æŸæ ‡å¿— (67å­—èŠ‚) ==========
        game_over = board_data[67]
        if game_over == 1:
            # æ ¹æ®åˆ†æ•°åˆ¤æ–­ç»“æœ
            if self.current_game.black_count > self.current_game.white_count:
                self.current_game.status = GameStatus.BLACK_WIN
            elif self.current_game.white_count > self.current_game.black_count:
                self.current_game.status = GameStatus.WHITE_WIN
            else:
                self.current_game.status = GameStatus.DRAW
        else:
            self.current_game.status = GameStatus.PLAYING

        # ========== 5. è§£æèµ°æ³•è®¡æ•° (68-71å­—èŠ‚, little-endian uint32) ==========
        move_count = struct.unpack('<I', board_data[68:72])[0]
        self.current_game.move_count = move_count

        # ========== æ—¥å¿—è¾“å‡º ==========
        logger.info(f"âœ… æ¸¸æˆçŠ¶æ€åŒæ­¥: ç©å®¶ {old_player.name}â†’{self.current_game.current_player.name}, "
                   f"é»‘={self.current_game.black_count}, ç™½={self.current_game.white_count}, "
                   f"æ­¥æ•°={move_count}")

        # ========== é€šçŸ¥è§‚å¯Ÿè€… ==========
        self._notify_observers('board_updated')

    except Exception as e:
        logger.error(f"âŒ è§£ææ¸¸æˆçŠ¶æ€å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
```

**é¢„æœŸæ•ˆæœ**:
- âœ… ä¸‹ä½æœºä¸‹æ£‹åï¼Œä¸Šä½æœºçš„ `current_player` æ­£ç¡®æ›´æ–°
- âœ… ä¸Šä½æœºæ˜¾ç¤ºçš„å¯ä¸‹ä½ç½®ä¸ä¸‹ä½æœºä¸€è‡´
- âœ… è½®æ¬¡åˆ‡æ¢æ­£ç¡®

---

### è§£å†³æ–¹æ¡ˆ2: å¢åŠ æ¸¸æˆæ¨¡å¼åŒæ­¥ï¼ˆæ¬¡è¦ï¼‰

#### 2.1 ä¸Šä½æœºå¢åŠ CMD_MODE_SELECTå¤„ç†

**ä¿®æ”¹æ–‡ä»¶**: `OthelloPC/main.py` (ç¬¬170è¡Œåæ·»åŠ )

```python
def on_serial_data_received(self, command, data):
    """å¤„ç†ä»STM32æ¥æ”¶åˆ°çš„æ•°æ®"""
    try:
        from communication.serial_handler import SerialProtocol

        if command == SerialProtocol.CMD_BOARD_STATE:  # 0x01
            # ... ç°æœ‰ä»£ç  ...

        # ========== æ–°å¢ï¼šå¤„ç†æ¨¡å¼é€‰æ‹© ==========
        elif command == SerialProtocol.CMD_MODE_SELECT:  # 0x0D
            if len(data) >= 3:
                import struct
                mode, time_limit = struct.unpack('<BH', data[:3])

                # æ¨¡å¼æ˜ å°„
                mode_map = {
                    1: 'normal',     # GAME_MODE_NORMAL
                    2: 'challenge',  # GAME_MODE_CHALLENGE
                    3: 'timed'       # GAME_MODE_TIMED
                }
                mode_name = mode_map.get(mode, 'normal')

                self.logger.info(f"ğŸ“‹ æ”¶åˆ°æ¨¡å¼é€‰æ‹©: {mode_name}, æ—¶é™={time_limit}ç§’")

                # é€šçŸ¥ä¸»çª—å£æ›´æ–°æ¨¡å¼
                if self.main_window:
                    self.main_window.on_mode_changed_from_stm32(mode_name, time_limit)
            else:
                self.logger.warning("CMD_MODE_SELECTæ•°æ®é•¿åº¦ä¸è¶³")

        # ... å…¶ä»–å‘½ä»¤å¤„ç† ...
```

#### 2.2 ä¸»çª—å£å¢åŠ æ¨¡å¼åŒæ­¥å›è°ƒ

**ä¿®æ”¹æ–‡ä»¶**: `OthelloPC/gui/main_window.py` (æ·»åŠ æ–°æ–¹æ³•)

```python
def on_mode_changed_from_stm32(self, mode_name: str, time_limit: int):
    """å¤„ç†æ¥è‡ªSTM32çš„æ¨¡å¼å˜åŒ–é€šçŸ¥"""
    try:
        self.logger.info(f"ğŸ”„ åŒæ­¥æ¸¸æˆæ¨¡å¼: {mode_name}, æ—¶é™={time_limit}ç§’")

        # æ›´æ–°æ§åˆ¶é¢æ¿çš„æ¨¡å¼æ˜¾ç¤º
        if self.control_panel:
            self.control_panel.set_mode(mode_name)

        # å¦‚æœæ˜¯è®¡æ—¶æ¨¡å¼ï¼Œå¯åŠ¨è®¡æ—¶å™¨
        if mode_name == 'timed' and time_limit > 0:
            if self.timed_mode_manager:
                self.timed_mode_manager.start(duration=time_limit)
                self.logger.info(f"â±ï¸ å¯åŠ¨è®¡æ—¶æ¨¡å¼: {time_limit}ç§’")

        # å¦‚æœæ˜¯é—¯å…³æ¨¡å¼ï¼Œåˆå§‹åŒ–
        elif mode_name == 'challenge':
            self.logger.info("ğŸ¯ è¿›å…¥é—¯å…³æ¨¡å¼")
            # å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–é—¯å…³æ¨¡å¼ç›¸å…³UI

        # æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        self._update_status_display()

    except Exception as e:
        self.logger.error(f"å¤„ç†æ¨¡å¼å˜åŒ–å¤±è´¥: {e}")
```

#### 2.3 ä¸‹ä½æœºå‘é€æ¨¡å¼é€šçŸ¥ï¼ˆå¦‚æœéœ€è¦ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `Core/Src/main.c` (åœ¨æ¨¡å¼åˆ‡æ¢å¤„æ·»åŠ )

```c
// å½“ä¸‹ä½æœºåˆ‡æ¢æ¨¡å¼æ—¶ï¼Œé€šçŸ¥ä¸Šä½æœº
void App_NotifyModeChanged(uint8_t mode, uint16_t time_limit)
{
    uint8_t mode_data[3];
    mode_data[0] = mode;        // æ¨¡å¼ (1=normal, 2=challenge, 3=timed)
    mode_data[1] = time_limit & 0xFF;        // æ—¶é™ä½å­—èŠ‚
    mode_data[2] = (time_limit >> 8) & 0xFF; // æ—¶é™é«˜å­—èŠ‚

    Protocol_SendPacket(CMD_MODE_SELECT, mode_data, sizeof(mode_data));
    DEBUG_INFO("[APP] Mode changed notification sent: mode=%d, time=%d\r\n", mode, time_limit);
}

// åœ¨æ¸¸æˆæ§åˆ¶çš„æ¨¡å¼åˆ‡æ¢å¤„è°ƒç”¨
// ä¾‹å¦‚åœ¨Game_Control_HandleKeyæˆ–Protocol_Command_Handlerä¸­
```

---

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| ä¼˜å…ˆçº§ | æ–‡ä»¶ | è¡Œæ•° | ä¿®æ”¹å†…å®¹ | è§£å†³é—®é¢˜ |
|--------|------|------|----------|----------|
| ğŸ”´ é«˜ | `OthelloPC/game/game_state.py` | 290-310 | å®Œæ•´è§£æ72å­—èŠ‚ï¼ŒåŒ…æ‹¬current_player | é—®é¢˜1ï¼šå¯ä¸‹ä½ç½®ä¸åŒ¹é… |
| ğŸŸ¡ ä¸­ | `OthelloPC/main.py` | 170å | æ·»åŠ CMD_MODE_SELECTå¤„ç† | é—®é¢˜2ï¼šæ¨¡å¼ä¸åŒæ­¥ |
| ğŸŸ¡ ä¸­ | `OthelloPC/gui/main_window.py` | æ–°å¢æ–¹æ³• | æ·»åŠ on_mode_changed_from_stm32() | é—®é¢˜2ï¼šæ¨¡å¼ä¸åŒæ­¥ |
| ğŸŸ¢ ä½ | `Core/Src/main.c` | é€‚å½“ä½ç½® | æ·»åŠ æ¨¡å¼é€šçŸ¥å‡½æ•°ï¼ˆå¯é€‰ï¼‰ | é—®é¢˜2ï¼šæ¨¡å¼ä¸åŒæ­¥ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯è®¡åˆ’

### æµ‹è¯•1: å¯ä¸‹ä½ç½®åŒæ­¥éªŒè¯

**æ­¥éª¤**:
1. å¯åŠ¨ä¸Šä½æœºå’Œä¸‹ä½æœºï¼Œå¼€å§‹æ–°æ¸¸æˆ
2. ä¸‹ä½æœºæŒ‰é”®ä¸‹æ£‹ï¼ˆKEY_5ï¼‰
3. è§‚å¯Ÿä¸Šä½æœºï¼š
   - æ£‹ç›˜æ˜¯å¦æ›´æ–°
   - å½“å‰ç©å®¶æ˜¯å¦åˆ‡æ¢ï¼ˆé»‘â†’ç™½æˆ–ç™½â†’é»‘ï¼‰
   - å¯ä¸‹ä½ç½®æŒ‡ç¤ºï¼ˆç»¿ç‚¹ï¼‰æ˜¯å¦æ­£ç¡®

**é¢„æœŸç»“æœ**:
- âœ… ä¸Šä½æœºå½“å‰ç©å®¶æ˜¾ç¤ºæ­£ç¡®
- âœ… å¯ä¸‹ä½ç½®æç¤ºä¸ä¸‹ä½æœºä¸€è‡´

### æµ‹è¯•2: æ¨¡å¼åŒæ­¥éªŒè¯

**æ­¥éª¤**:
1. åœ¨ä¸‹ä½æœºé€‰æ‹©é—¯å…³æ¨¡å¼æˆ–è®¡æ—¶æ¨¡å¼
2. è§‚å¯Ÿä¸Šä½æœºï¼š
   - æ¨¡å¼æ˜¾ç¤ºæ˜¯å¦æ›´æ–°
   - è®¡æ—¶æ¨¡å¼ä¸‹æ˜¯å¦å¯åŠ¨å€’è®¡æ—¶
   - æ§åˆ¶é¢æ¿çš„æ¨¡å¼é€‰æ‹©æ˜¯å¦åŒæ­¥

**é¢„æœŸç»“æœ**:
- âœ… ä¸Šä½æœºæ­£ç¡®æ˜¾ç¤ºå½“å‰æ¨¡å¼
- âœ… è®¡æ—¶æ¨¡å¼ä¸‹å€’è®¡æ—¶æ­£å¸¸å·¥ä½œ

---

## âš ï¸ é£é™©è¯„ä¼°

| ä¿®æ”¹ | é£é™© | è¯´æ˜ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| ä¿®å¤current_playeråŒæ­¥ | ğŸŸ¢ ä½ | åªæ”¹æ¥æ”¶é€»è¾‘ | å¤‡ä»½åŸæ–‡ä»¶ |
| æ·»åŠ æ¨¡å¼å¤„ç† | ğŸŸ¢ ä½ | æ–°å¢ä»£ç ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ | å…ˆæµ‹è¯•ä¸å½±å“ç°æœ‰æµç¨‹ |

---

## ğŸ“ å®æ–½æ­¥éª¤

1. **ç¬¬ä¸€æ­¥**: ä¿®å¤é—®é¢˜1ï¼ˆæœ€å…³é”®ï¼‰
   - ä¿®æ”¹ `game_state.py:update_board_state()`
   - å®Œæ•´è§£æ72å­—èŠ‚æ•°æ®
   - æµ‹è¯•ä¸‹ä½æœºä¸‹æ£‹åä¸Šä½æœºåŒæ­¥

2. **ç¬¬äºŒæ­¥**: æ·»åŠ æ¨¡å¼åŒæ­¥ï¼ˆå¯é€‰ï¼‰
   - ä¿®æ”¹ `main.py:on_serial_data_received()`
   - ä¿®æ”¹ `main_window.py` æ·»åŠ å›è°ƒ
   - æµ‹è¯•æ¨¡å¼åˆ‡æ¢

---

**æ–‡æ¡£ç»“æŸ**

ä¸‹ä¸€æ­¥ï¼šå¾å¾—ç”¨æˆ·åŒæ„åï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§å®æ–½ä¿®æ”¹ã€‚
