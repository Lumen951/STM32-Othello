# STM32 黑白棋启动指南

## 前置准备

### 硬件清单
- [x] STM32F103C8T6开发板
- [x] WS2812B-64 LED矩阵(8×8)
- [x] 4×4矩阵键盘
- [x] USB转TTL串口模块
- [x] 5V/5A电源适配器
- [x] 杜邦线若干

### 软件清单
- [x] STM32CubeIDE (已安装HAL库)
- [x] ST-Link驱动(用于烧录)
- [x] 串口调试工具(如PuTTY, SecureCRT)

---

## 一、硬件连接

参照《硬件连接指南.md》完成以下连接:

1. **WS2812B-64连接**
   - U+ → 外部5V电源
   - U- → 外部5V GND + STM32 GND
   - IN → STM32 PA0

2. **4×4键盘连接**
   - R1~R4 → PB12~PB15
   - C1~C4 → PB5~PB8

3. **UART连接**
   - PA9(TX) → 串口模块RX
   - PA10(RX) → 串口模块TX
   - GND → 串口模块GND

---

## 二、项目编译与烧录

### 1. 打开项目
```bash
# 双击打开项目文件
STM32_Othello.ioc
```

### 2. 编译项目
- 在STM32CubeIDE中点击 **Project → Build All**
- 等待编译完成,确认无错误信息

### 3. 烧录程序
- 连接ST-Link到STM32开发板
- 点击 **Run → Debug** 或按 **F11**
- 首次烧录会自动配置调试器
- 烧录完成后程序自动运行

---

## 三、系统启动验证

### 启动时序
程序上电后会按以下顺序初始化:

1. **HAL库初始化** (闪存/时钟/SysTick)
2. **系统时钟配置** (HSE 8MHz → PLL 72MHz)
3. **GPIO初始化** (LED/键盘/UART引脚)
4. **DMA初始化** (DMA1 Channel5用于WS2812B)
5. **TIM2初始化** (PWM 800kHz用于WS2812B)
6. **USART1初始化** (115200波特率)
7. **外设驱动初始化**
   - WS2812B驱动初始化
   - 键盘驱动初始化
   - UART协议层初始化
8. **游戏引擎初始化**
9. **显示启动RGB测试图案** (彩虹色依次闪烁)

### 验证步骤

#### 步骤1: LED测试
- **预期现象**: LED矩阵显示RGB彩虹测试图案(约2秒)
- **如果失败**: 检查PA0连接和5V电源

#### 步骤2: 初始棋盘显示
- **预期现象**: LED矩阵显示初始黑白棋局面
  ```
  中央4格:
  (3,3): 白色  (3,4): 黑色
  (4,3): 黑色  (4,4): 白色
  其他格: 熄灭
  ```
- **如果失败**: 检查游戏引擎初始化

#### 步骤3: 键盘测试
- **操作**: 随意按下键盘任意键
- **预期现象**: 对应LED位置短暂显示绿色
- **如果失败**: 检查PB5-8和PB12-15连接

#### 步骤4: UART通信测试
- **操作**: 打开串口调试工具(115200,8N1)
- **预期现象**:
  - 按键时收到 `KEY_EVENT` 数据包
  - 可发送 `CMD_SYSTEM_INFO` 查询系统信息
- **如果失败**: 检查PA9/PA10交叉连接

---

## 四、基本操作

### 键盘功能映射

| 逻辑键 | 物理位置 | 功能 | 说明 |
|:---:|:---:|:---|:---|
| **1** | [0,0] | 新游戏 | 开始新一局并保存统计 |
| **5** | [1,1] | 确认落子 | 在当前位置落子 |
| **0** | [3,1] | 重置游戏 | 重新开始不保存统计 |
| **9** | [2,2] | 发送棋局 | 通过UART发送当前棋局到PC |
| 其他 | - | 坐标选择 | 按键位置映射到棋盘坐标 |

### 游戏流程

1. **开局**: 系统自动初始化为黑子先手
2. **落子**: 按下对应坐标键 → 按键5确认
3. **合法性检查**:
   - 合法: LED显示新棋局,自动切换玩家
   - 非法: LED短暂显示红色警告
4. **游戏结束**: LED全屏显示胜方颜色(5秒)
   - 黑胜: 全黑
   - 白胜: 全白
   - 平局: 黑白棋盘格交替

---

## 五、UART通信协议

### 串口配置
```
波特率: 115200
数据位: 8
停止位: 1
校验位: 无
流控: 无
```

### 主要命令

| 命令代码 | 名称 | 方向 | 说明 |
|:---:|:---|:---:|:---|
| `0x11` | `CMD_MAKE_MOVE` | PC→STM32 | 请求落子 |
| `0x12` | `CMD_BOARD_STATE` | PC→STM32 | 请求当前棋局 |
| `0x15` | `CMD_AI_REQUEST` | PC→STM32 | 请求AI分析 |
| `0x22` | `CMD_KEY_EVENT` | STM32→PC | 键盘事件上报 |
| `0x23` | `CMD_GAME_STATE` | STM32→PC | 棋局状态推送 |
| `0xF0` | `CMD_HEARTBEAT` | 双向 | 心跳包 |

### 测试命令示例

#### 发送落子命令(行3,列4)
```
帧头: AA 55
命令: 11
长度: 02
数据: 03 04
校验: (11+02+03+04) & 0xFF = 1A
完整: AA 55 11 02 03 04 1A
```

#### 查询棋局状态
```
帧头: AA 55
命令: 12
长度: 00
校验: 12
完整: AA 55 12 00 12
```

---

## 六、常见问题排查

### 问题1: LED不亮或颜色异常
**原因**: DMA数据宽度配置错误
**解决**: 确认DMA配置为Half Word(16位),检查`main.c:264`的Period为`90-1`

### 问题2: 键盘按下无反应
**原因**: 上拉电阻未启用
**解决**: 检查`main.c:378`列引脚配置为`GPIO_PULLUP`

### 问题3: UART收不到数据
**原因**: 波特率不匹配或TX/RX反接
**解决**: 确认串口工具设置115200,检查交叉连接

### 问题4: 程序卡死在Error_Handler
**原因**: 外设初始化失败
**解决**:
- 检查时钟配置(HSE晶振是否匹配)
- 确认引脚定义与硬件连接一致

### 问题5: LED颜色偏移错误
**原因**: WS2812B时序不准确
**解决**: 测量PA0输出波形:
- 高电平: ~0.85μs (逻辑1) / ~0.40μs (逻辑0)
- 低电平: ~0.40μs (逻辑1) / ~0.85μs (逻辑0)

---

## 七、调试技巧

### 1. 查看系统状态
通过UART发送`CMD_SYSTEM_INFO`获取:
- 系统运行时间
- 当前游戏状态
- 中断优先级配置

### 2. 手动控制LED
使用`CMD_LED_CONTROL`命令直接控制单个LED:
```
AA 55 16 05 00 00 FF 00 00 CB
    └─┘ └─┘ └─┘ └──────┘ └─┘
    命令 长度 行列  RGB颜色  校验
```

### 3. 查看调试信息
在STM32CubeIDE中:
- 设置断点: 双击代码行号
- 查看变量: **Window → Show View → Variables**
- 单步调试: **F6**(Step Over) / **F5**(Step Into)

---

## 八、PC上位机启动(重点)

### 前置准备

#### 软件需求
- **Python**: 3.7或更高版本
- **操作系统**: Windows 10/11, Linux, macOS
- **可用内存**: 至少512MB
- **USB串口驱动**: CH340G/CP2102驱动(根据串口模块型号)

#### 依赖包
PC上位机需要以下Python包:
- `tkinter` (Python内置,用于GUI)
- `pyserial>=3.5` (串口通信)
- `requests>=2.28.0` (DeepSeek API调用)

---

### 方法1: 使用启动脚本(推荐)

#### Windows系统
```bash
# 进入上位机目录
cd STM32_Othello\OthelloPC

# 双击运行批处理脚本
start.bat
```

**脚本会自动执行**:
1. 检查Python环境
2. 激活虚拟环境(如果存在)
3. 自动安装缺失的依赖包
4. 启动GUI应用

#### Linux/macOS系统
```bash
# 进入上位机目录
cd STM32_Othello/OthelloPC

# 添加执行权限(首次运行)
chmod +x start.sh

# 运行启动脚本
./start.sh
```

---

### 方法2: 手动启动

#### 步骤1: 安装依赖
```bash
cd STM32_Othello\OthelloPC

# Windows
pip install -r requirements.txt

# Linux/macOS
pip3 install -r requirements.txt
```

#### 步骤2: 启动应用
```bash
# Windows
python run.py

# Linux/macOS
python3 run.py
```

---

### 方法3: 使用虚拟环境(开发推荐)

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# Linux/macOS:
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 启动应用
python run.py
```

---

### PC上位机启动验证

#### 预期启动过程
```
====================================
STM32 黑白棋 PC上位机 v1.0
STM32 Othello PC Client
====================================

正在检查依赖项...
正在启动应用...
==================================================
STM32 Othello PC Client v1.0
PC上位机交互前端
==================================================
初始化STM32 Othello PC客户端...
应用程序初始化完成
启动应用程序主循环
```

#### GUI界面
启动成功后会弹出窗口:
- **标题**: "STM32 Othello - PC上位机 v1.0"
- **尺寸**: 1200×800像素
- **布局**:
  - 左侧: 游戏棋盘(8×8)
  - 右侧: 历史记录和统计面板
  - 顶部: 工具栏(新游戏/连接STM32/设置)

---

### 连接STM32硬件

#### 步骤1: 确认COM端口
**Windows**:
1. 打开"设备管理器"
2. 展开"端口(COM和LPT)"
3. 找到"USB-SERIAL CH340 (COMx)"或类似设备
4. 记录端口号(如COM3)

**Linux**:
```bash
# 查看串口设备
ls /dev/ttyUSB*
# 或
dmesg | grep tty
```

**macOS**:
```bash
ls /dev/cu.usbserial*
```

#### 步骤2: 在GUI中连接
1. 点击顶部工具栏的"**连接STM32**"按钮
2. 在弹出的对话框中选择COM端口
3. 波特率默认为115200(无需修改)
4. 点击"**连接**"

#### 步骤3: 验证连接
连接成功后会显示:
- 状态栏显示"**已连接**"(绿色)
- 开始接收STM32发送的棋局状态
- 按下STM32按键时,GUI实时显示按键事件

---

### PC上位机功能使用

#### 1. 基本对弈
- **开始新游戏**: 点击"新游戏"按钮
- **查看棋盘**: 在GUI上实时显示STM32硬件棋盘状态
- **PC落子**: 在GUI棋盘上点击位置,自动发送到STM32
- **硬件落子**: 使用STM32键盘,GUI自动同步

#### 2. DeepSeek AI分析(可选)
**配置API密钥**:
1. 点击菜单 "**分析**" → "**DeepSeek设置**"
2. 访问 https://platform.deepseek.com/ 获取API密钥
3. 粘贴密钥并保存

**使用AI分析**:
1. 游戏进行中或结束后,点击"**AI分析**"
2. 等待DeepSeek生成报告(约5-10秒)
3. 查看开局/中局/残局分析和改进建议

#### 3. 棋谱管理
- **自动记录**: 每步棋自动记录在历史面板
- **导出棋谱**: 文件 → 导出PGN格式棋谱
- **加载棋谱**: 文件 → 加载已保存的游戏

#### 4. 实时状态监控
右侧面板显示:
- 当前玩家(黑/白)
- 棋子数量统计
- 移动历史记录
- 连接状态指示器

---

### 上位机故障排查

#### 问题1: 无法启动GUI
**错误信息**: `ImportError: No module named 'tkinter'`
**原因**: tkinter未安装
**解决**:
```bash
# Ubuntu/Debian
sudo apt-get install python3-tk

# Fedora
sudo dnf install python3-tkinter

# macOS (使用官方Python安装包,tkinter已内置)
# Windows (tkinter已内置)
```

#### 问题2: 依赖安装失败
**错误信息**: `pip install failed`
**解决**:
```bash
# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或升级pip
python -m pip install --upgrade pip
```

#### 问题3: 找不到COM端口
**原因**: 串口驱动未安装
**解决**:
- CH340驱动: http://www.wch.cn/downloads/CH341SER_EXE.html
- CP2102驱动: https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers

#### 问题4: 连接后无数据
**检查项**:
1. STM32是否正常运行(LED是否显示测试图案)
2. 串口线是否交叉连接(TX→RX, RX→TX)
3. 波特率是否为115200
4. 使用串口调试工具(如PuTTY)测试原始数据

#### 问题5: DeepSeek分析失败
**可能原因**:
- API密钥错误 → 重新配置
- 网络无法访问 → 检查防火墙
- API余额不足 → 充值账户

---

### 日志文件位置

上位机运行时会生成日志:
```
OthelloPC/
└── logs/
    ├── STM32_Othello_20251128.log       # 常规日志
    └── STM32_Othello_error_20251128.log # 错误日志
```

查看日志有助于诊断问题:
```bash
# Windows
type logs\STM32_Othello_20251128.log

# Linux/macOS
cat logs/STM32_Othello_20251128.log
```

---

## 九、完整系统工作流程

### 单机模式(仅STM32)
1. 烧录STM32固件
2. 上电启动
3. 使用4×4键盘操作
4. WS2812B LED显示棋盘

### PC联机模式(STM32 + 上位机)
1. 烧录STM32固件并启动
2. 连接USB串口到PC
3. 启动PC上位机(`start.bat` 或 `python run.py`)
4. 在GUI中点击"连接STM32"
5. 双向同步:
   - STM32键盘落子 → GUI实时显示
   - GUI点击落子 → STM32 LED显示
6. 可选使用DeepSeek AI分析

### AI辅助模式
1. 完成上述PC联机模式连接
2. 配置DeepSeek API密钥
3. 对弈过程中点击"AI分析"获取最佳策略
4. 游戏结束后自动生成复盘报告

---

## 十、下一步

系统正常启动后,推荐按以下顺序体验:

1. **单机测试**: 先在STM32上独立运行,验证硬件功能
2. **串口连接**: 使用串口调试工具测试通信协议
3. **上位机连接**: 启动GUI并连接STM32
4. **完整对弈**: PC端和硬件端双向操作测试
5. **AI分析**: 配置DeepSeek并体验智能分析功能

详细协议定义请参考: `Core/Inc/uart_protocol.h`
游戏引擎API请参考: `Core/Inc/othello_engine.h`
上位机完整文档: `OthelloPC/README.md`
