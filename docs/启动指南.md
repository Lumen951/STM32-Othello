# STM32 黑白棋启动指南

## 前置准备

### 硬件清单
- [x] STM32F103C8T6开发板
- [x] WS2812B-64 LED矩阵(8×8)
- [x] 4×4矩阵键盘
- [x] USB转TTL串口模块
- [x] 5V/5A电源适配器
- [x] 杜邦线若干

### 软件清单
- [x] STM32CubeIDE (已安装HAL库)
- [x] ST-Link驱动(用于烧录)
- [x] 串口调试工具(如PuTTY, SecureCRT)

---

## 一、硬件连接

参照《硬件连接指南.md》完成以下连接:

1. **WS2812B-64连接**
   - U+ → 外部5V电源
   - U- → 外部5V GND + STM32 GND
   - IN → STM32 PA0

2. **4×4键盘连接**
   - R1~R4 → PB12~PB15
   - C1~C4 → PB5~PB8

3. **UART连接**
   - PA9(TX) → 串口模块RX
   - PA10(RX) → 串口模块TX
   - GND → 串口模块GND

---

## 二、项目编译与烧录

### 1. 打开项目
```bash
# 双击打开项目文件
STM32_Othello.ioc
```

### 2. 编译项目
- 在STM32CubeIDE中点击 **Project → Build All**
- 等待编译完成,确认无错误信息

### 3. 烧录程序
- 连接ST-Link到STM32开发板
- 点击 **Run → Debug** 或按 **F11**
- 首次烧录会自动配置调试器
- 烧录完成后程序自动运行

---

## 三、系统启动验证

### 启动时序
程序上电后会按以下顺序初始化:

1. **HAL库初始化** (闪存/时钟/SysTick)
2. **系统时钟配置** (HSE 8MHz → PLL 72MHz)
3. **GPIO初始化** (LED/键盘/UART引脚)
4. **DMA初始化** (DMA1 Channel5用于WS2812B)
5. **TIM2初始化** (PWM 800kHz用于WS2812B)
6. **USART1初始化** (115200波特率)
7. **外设驱动初始化**
   - WS2812B驱动初始化
   - 键盘驱动初始化
   - UART协议层初始化
8. **游戏引擎初始化**
9. **显示启动RGB测试图案** (彩虹色依次闪烁)

### 验证步骤

#### 步骤1: LED测试
- **预期现象**: LED矩阵显示RGB彩虹测试图案(约2秒)
- **如果失败**: 检查PA0连接和5V电源

#### 步骤2: 初始棋盘显示
- **预期现象**: LED矩阵显示初始黑白棋局面
  ```
  中央4格:
  (3,3): 白色  (3,4): 黑色
  (4,3): 黑色  (4,4): 白色
  其他格: 熄灭
  ```
- **如果失败**: 检查游戏引擎初始化

#### 步骤3: 键盘测试
- **操作**: 随意按下键盘任意键
- **预期现象**: 对应LED位置短暂显示绿色
- **如果失败**: 检查PB5-8和PB12-15连接

#### 步骤4: UART通信测试
- **操作**: 打开串口调试工具(115200,8N1)
- **预期现象**:
  - 按键时收到 `KEY_EVENT` 数据包
  - 可发送 `CMD_SYSTEM_INFO` 查询系统信息
- **如果失败**: 检查PA9/PA10交叉连接

---

## 四、基本操作

### 键盘功能映射

| 逻辑键 | 物理位置 | 功能 | 说明 |
|:---:|:---:|:---|:---|
| **1** | [0,0] | 新游戏 | 开始新一局并保存统计 |
| **5** | [1,1] | 确认落子 | 在当前位置落子 |
| **0** | [3,1] | 重置游戏 | 重新开始不保存统计 |
| **9** | [2,2] | 发送棋局 | 通过UART发送当前棋局到PC |
| 其他 | - | 坐标选择 | 按键位置映射到棋盘坐标 |

### 游戏流程

1. **开局**: 系统自动初始化为黑子先手
2. **落子**: 按下对应坐标键 → 按键5确认
3. **合法性检查**:
   - 合法: LED显示新棋局,自动切换玩家
   - 非法: LED短暂显示红色警告
4. **游戏结束**: LED全屏显示胜方颜色(5秒)
   - 黑胜: 全黑
   - 白胜: 全白
   - 平局: 黑白棋盘格交替

---

## 五、UART通信协议

### 串口配置
```
波特率: 115200
数据位: 8
停止位: 1
校验位: 无
流控: 无
```

### 主要命令

| 命令代码 | 名称 | 方向 | 说明 |
|:---:|:---|:---:|:---|
| `0x11` | `CMD_MAKE_MOVE` | PC→STM32 | 请求落子 |
| `0x12` | `CMD_BOARD_STATE` | PC→STM32 | 请求当前棋局 |
| `0x15` | `CMD_AI_REQUEST` | PC→STM32 | 请求AI分析 |
| `0x22` | `CMD_KEY_EVENT` | STM32→PC | 键盘事件上报 |
| `0x23` | `CMD_GAME_STATE` | STM32→PC | 棋局状态推送 |
| `0xF0` | `CMD_HEARTBEAT` | 双向 | 心跳包 |

### 测试命令示例

#### 发送落子命令(行3,列4)
```
帧头: AA 55
命令: 11
长度: 02
数据: 03 04
校验: (11+02+03+04) & 0xFF = 1A
完整: AA 55 11 02 03 04 1A
```

#### 查询棋局状态
```
帧头: AA 55
命令: 12
长度: 00
校验: 12
完整: AA 55 12 00 12
```

---

## 六、常见问题排查

### 问题1: LED不亮或颜色异常
**原因**: DMA数据宽度配置错误
**解决**: 确认DMA配置为Half Word(16位),检查`main.c:264`的Period为`90-1`

### 问题2: 键盘按下无反应
**原因**: 上拉电阻未启用
**解决**: 检查`main.c:378`列引脚配置为`GPIO_PULLUP`

### 问题3: UART收不到数据
**原因**: 波特率不匹配或TX/RX反接
**解决**: 确认串口工具设置115200,检查交叉连接

### 问题4: 程序卡死在Error_Handler
**原因**: 外设初始化失败
**解决**:
- 检查时钟配置(HSE晶振是否匹配)
- 确认引脚定义与硬件连接一致

### 问题5: LED颜色偏移错误
**原因**: WS2812B时序不准确
**解决**: 测量PA0输出波形:
- 高电平: ~0.85μs (逻辑1) / ~0.40μs (逻辑0)
- 低电平: ~0.40μs (逻辑1) / ~0.85μs (逻辑0)

---

## 七、调试技巧

### 1. 查看系统状态
通过UART发送`CMD_SYSTEM_INFO`获取:
- 系统运行时间
- 当前游戏状态
- 中断优先级配置

### 2. 手动控制LED
使用`CMD_LED_CONTROL`命令直接控制单个LED:
```
AA 55 16 05 00 00 FF 00 00 CB
    └─┘ └─┘ └─┘ └──────┘ └─┘
    命令 长度 行列  RGB颜色  校验
```

### 3. 查看调试信息
在STM32CubeIDE中:
- 设置断点: 双击代码行号
- 查看变量: **Window → Show View → Variables**
- 单步调试: **F6**(Step Over) / **F5**(Step Into)

---

## 八、下一步

系统正常启动后,可以:

1. **单机模式**: 直接使用键盘和LED玩黑白棋
2. **PC联机模式**: 通过串口连接PC上位机
3. **AI对战模式**: PC发送AI计算的最佳落子位置
4. **统计分析**: 通过UART获取游戏统计数据

详细协议定义请参考: `Core/Inc/uart_protocol.h`
游戏引擎API请参考: `Core/Inc/othello_engine.h`
