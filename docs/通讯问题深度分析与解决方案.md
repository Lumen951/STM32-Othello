# STM32 Othello é€šè®¯é—®é¢˜æ·±åº¦åˆ†æä¸å®Œæ•´è§£å†³æ–¹æ¡ˆ

**æ–‡æ¡£åˆ›å»ºæ—¥æœŸ**: 2025-12-17
**åˆ†æäºº**: Claude Sonnet 4.5
**é—®é¢˜æ¥æº**: commit d7cc468 æåˆ°çš„å·²çŸ¥é—®é¢˜

---

## ğŸ“Š é—®é¢˜ç°çŠ¶æ€»ç»“

ç»è¿‡æ·±åº¦ä»£ç åˆ†æï¼Œå‘ç°ä»¥ä¸‹**3ä¸ªæ ¸å¿ƒé—®é¢˜**å’Œ**1ä¸ªæ¬¡è¦é—®é¢˜**ï¼š

---

## ğŸ”´ æ ¸å¿ƒé—®é¢˜1: æ•°æ®æ ¼å¼ä¸åŒ¹é…å¯¼è‡´ä¸åŒæ­¥

### é—®é¢˜æ ¹æºï¼ˆå·²ç¡®è®¤ï¼‰

**ä¸‹ä½æœºå‘é€çš„æ•°æ®** (`uart_protocol.h:114-121`):
```c
typedef struct {
    uint8_t board[8][8];        // 64 bytes - æ£‹ç›˜æ•°æ®
    uint8_t current_player;     // 1 byte  - å½“å‰ç©å®¶
    uint8_t black_count;        // 1 byte  - é»‘æ£‹æ•°é‡
    uint8_t white_count;        // 1 byte  - ç™½æ£‹æ•°é‡
    uint8_t game_over;          // 1 byte  - æ¸¸æˆç»“æŸæ ‡å¿—
    uint32_t move_count;        // 4 bytes - èµ°æ³•è®¡æ•°
} Game_State_Data_t;
// æ€»å¤§å°: 72 bytes
```

**ä¸Šä½æœºæœŸæœ›æ¥æ”¶çš„æ•°æ®** (`game_state.py:290-303`):
```python
def update_board_state(self, board_data: bytes):
    """ä»STM32æ›´æ–°æ£‹ç›˜çŠ¶æ€"""
    # âŒ å‡è®¾æ•°æ®æ ¼å¼: 64å­—èŠ‚è¡¨ç¤º8x8æ£‹ç›˜çŠ¶æ€
    if len(board_data) >= 64:  # âš ï¸ åªæ£€æŸ¥64å­—èŠ‚
        for i in range(64):    # âš ï¸ åªè¯»å–å‰64å­—èŠ‚ï¼ˆæ£‹ç›˜ï¼‰
            row = i // 8
            col = i % 8
            piece_value = board_data[i]
            self.current_game.board[row][col] = PieceType(piece_value)

        # æ›´æ–°è®¡æ•°
        self.current_game._update_piece_counts()  # âš ï¸ é‡æ–°è®¡ç®—ï¼Œæ²¡æœ‰ä½¿ç”¨ä¼ æ¥çš„è®¡æ•°
```

### é—®é¢˜åˆ†æ

1. **æ•°æ®å¤§å°ä¸åŒ¹é…**:
   - ä¸‹ä½æœºå‘é€: 72 bytes (å®Œæ•´çš„ `Game_State_Data_t`)
   - ä¸Šä½æœºåªè¯»: å‰64 bytes (åªè¯» `board[8][8]`)
   - **è¢«å¿½ç•¥çš„8å­—èŠ‚**: `current_player`, `black_count`, `white_count`, `game_over`, `move_count`

2. **æ•°æ®æœªå®Œæ•´åˆ©ç”¨**:
   - ä¸‹ä½æœºå‘é€äº†å½“å‰ç©å®¶ä¿¡æ¯ï¼Œä½†ä¸Šä½æœºæ²¡æœ‰ä½¿ç”¨
   - ä¸‹ä½æœºå‘é€äº†æ£‹å­è®¡æ•°ï¼Œä½†ä¸Šä½æœºé‡æ–°è®¡ç®—ï¼ˆæ•ˆç‡ä½ä¸”å¯èƒ½ä¸ä¸€è‡´ï¼‰
   - ä¸‹ä½æœºå‘é€äº†æ¸¸æˆçŠ¶æ€ï¼Œä½†ä¸Šä½æœºæ²¡æœ‰æ›´æ–°

3. **åŒæ­¥ä¸å®Œæ•´**:
   - ä¸Šä½æœºæ›´æ–°äº†æ£‹ç›˜ï¼Œä½†**æ²¡æœ‰æ›´æ–°å½“å‰ç©å®¶**
   - ä¸Šä½æœºæ›´æ–°äº†æ£‹ç›˜ï¼Œä½†**æ²¡æœ‰æ›´æ–°æ¸¸æˆçŠ¶æ€**ï¼ˆè¿›è¡Œä¸­/ç»“æŸï¼‰
   - è¿™å¯¼è‡´ä¸‹ä½æœºä¸‹æ£‹åï¼Œä¸Šä½æœºè™½ç„¶çœ‹åˆ°æ£‹ç›˜å˜åŒ–ï¼Œä½†**è½®åˆ°è°ä¸‹æ£‹æ··ä¹±**

### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹ä¸Šä½æœº** `game_state.py:290-320`:

```python
def update_board_state(self, board_data: bytes):
    """ä»STM32æ›´æ–°å®Œæ•´æ¸¸æˆçŠ¶æ€"""
    import struct

    # æ£€æŸ¥æ•°æ®é•¿åº¦ï¼ˆåº”è¯¥æ˜¯72å­—èŠ‚ï¼‰
    if len(board_data) < 72:
        self.logger.error(f"æ¸¸æˆçŠ¶æ€æ•°æ®ä¸å®Œæ•´: æ¥æ”¶{len(board_data)}å­—èŠ‚, æœŸæœ›72å­—èŠ‚")
        return

    try:
        # è§£æå®Œæ•´çš„Game_State_Data_tç»“æ„
        # board[8][8]: 64 bytes (offset 0-63)
        for i in range(64):
            row = i // 8
            col = i % 8
            piece_value = board_data[i]
            self.current_game.board[row][col] = PieceType(piece_value)

        # current_player: 1 byte (offset 64)
        current_player_value = board_data[64]
        self.current_game.current_player = PieceType(current_player_value)

        # black_count: 1 byte (offset 65)
        self.current_game.black_count = board_data[65]

        # white_count: 1 byte (offset 66)
        self.current_game.white_count = board_data[66]

        # game_over: 1 byte (offset 67)
        game_over = board_data[67]
        if game_over == 1:
            # æ ¹æ®åˆ†æ•°åˆ¤æ–­æ¸¸æˆç»“æœ
            if self.current_game.black_count > self.current_game.white_count:
                self.current_game.status = GameStatus.BLACK_WIN
            elif self.current_game.white_count > self.current_game.black_count:
                self.current_game.status = GameStatus.WHITE_WIN
            else:
                self.current_game.status = GameStatus.DRAW
        else:
            self.current_game.status = GameStatus.PLAYING

        # move_count: 4 bytes (offset 68-71, little-endian uint32)
        move_count = struct.unpack('<I', board_data[68:72])[0]
        self.current_game.move_count = move_count

        self.logger.info(f"âœ… æ¸¸æˆçŠ¶æ€åŒæ­¥å®Œæˆ: ç©å®¶={current_player_value}, é»‘={self.current_game.black_count}, ç™½={self.current_game.white_count}, æ­¥æ•°={move_count}")

        # é€šçŸ¥è§‚å¯Ÿè€…ï¼ˆè§¦å‘UIæ›´æ–°ï¼‰
        self._notify_observers('board_updated')

    except Exception as e:
        self.logger.error(f"è§£ææ¸¸æˆçŠ¶æ€å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
```

**ä¿®æ”¹æ–‡ä»¶**: `OthelloPC/game/game_state.py` (ç¬¬290-320è¡Œ)

---

## ğŸ”´ æ ¸å¿ƒé—®é¢˜2: ä¸»å¾ªç¯ä¸­çš„é˜»å¡å»¶è¿Ÿ

### é—®é¢˜æ ¹æºï¼ˆå·²ç¡®è®¤ï¼‰

**ä¸»å¾ªç¯ä¸­çš„å»¶è¿Ÿ** (`main.c:254`):
```c
while (1)
{
  /* Keypad scan */
  Keypad_Scan_Task();

  /* Protocol maintenance tasks (heartbeat & timeout handling) */
  Protocol_Task();

  /* Small delay to prevent excessive CPU usage */
  HAL_Delay(1);  // âš ï¸ æ¯æ¬¡å¾ªç¯å»¶è¿Ÿ1ms
}
```

**æ— æ•ˆèµ°æ³•æ—¶çš„é•¿å»¶è¿Ÿ** (`main.c:680`):
```c
case KEYPAD_KEY_5: // Place Piece at Cursor
  if (Othello_IsValidMove(...)) {
    // èµ°æ£‹æˆåŠŸ
  } else {
    // æ— æ•ˆèµ°æ³• - çº¢è‰²é—ªçƒ
    WS2812B_SetPixel(cursor_row, cursor_col, WS2812B_COLOR_RED);
    WS2812B_Update();
    HAL_Delay(200);  // âŒ é˜»å¡200msï¼
    App_DisplayGameBoard();
  }
  break;
```

**æ¸¸æˆç»“æŸæ—¶çš„è¶…é•¿å»¶è¿Ÿ** (`main.c:851, 856, 889`):
```c
HAL_Delay(3000);  // âŒ é˜»å¡3ç§’
HAL_Delay(5000);  // âŒ é˜»å¡5ç§’
```

### é—®é¢˜åˆ†æ

1. **ä¸»å¾ªç¯å»¶è¿Ÿç´¯ç§¯**:
   - æ¯æ¬¡å¾ªç¯: 1ms (HAL_Delay)
   - é”®ç›˜æ‰«æ: ~0.5ms
   - åè®®å¤„ç†: ~0.5ms
   - **æ€»å»¶è¿Ÿ**: ~2ms/å¾ªç¯

2. **é˜»å¡å¯¼è‡´å“åº”æ…¢**:
   - æ— æ•ˆèµ°æ³•é˜»å¡200ms â†’ ç”¨æˆ·é‡è¯•æ—¶æ„Ÿè§‰å¡é¡¿
   - æ¸¸æˆç»“æŸé˜»å¡3-5ç§’ â†’ æœŸé—´æ— æ³•å¤„ç†ä»»ä½•å‘½ä»¤
   - ä¸Šä½æœºå‘é€å‘½ä»¤æ—¶ï¼Œä¸‹ä½æœºå¯èƒ½æ­£åœ¨é˜»å¡ä¸­

3. **åè®®å¤„ç†ä¸åŠæ—¶**:
   - ä¸Šä½æœºå‘é€å‘½ä»¤åï¼Œä¸‹ä½æœºå¯èƒ½åœ¨`HAL_Delay()`ä¸­
   - å‘½ä»¤è™½ç„¶è¢«UARTä¸­æ–­æ¥æ”¶ï¼Œä½†å¤„ç†å»¶è¿Ÿ

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: ç§»é™¤é˜»å¡å»¶è¿Ÿï¼Œä½¿ç”¨çŠ¶æ€æœº

**ä¿®æ”¹ `main.c`**:

```c
// å…¨å±€å˜é‡ï¼ˆåœ¨main.cå¼€å¤´æ·»åŠ ï¼‰
static uint32_t invalid_move_flash_start = 0;
static bool invalid_move_flashing = false;
static uint32_t game_result_display_start = 0;
static bool game_result_displaying = false;

// ä¿®æ”¹æ— æ•ˆèµ°æ³•å¤„ç†ï¼ˆmain.c:675-682ï¼‰
case KEYPAD_KEY_5: // Place Piece at Cursor
  if (Othello_IsValidMove(&game_state, cursor_row, cursor_col, game_state.current_player)) {
    // ... èµ°æ£‹æˆåŠŸé€»è¾‘ ...
  } else {
    DEBUG_INFO("[APP] Invalid move at (%d,%d)\r\n", cursor_row, cursor_col);
    // å¯åŠ¨çº¢è‰²é—ªçƒï¼ˆä¸é˜»å¡ï¼‰
    invalid_move_flashing = true;
    invalid_move_flash_start = HAL_GetTick();
    WS2812B_SetPixel(cursor_row, cursor_col, WS2812B_COLOR_RED);
    WS2812B_Update();
  }
  break;

// åœ¨ä¸»å¾ªç¯ä¸­å¤„ç†é—ªçƒï¼ˆmain.c:255ä¹‹å‰æ·»åŠ ï¼‰
/* Handle invalid move flashing (non-blocking) */
if (invalid_move_flashing) {
  if ((HAL_GetTick() - invalid_move_flash_start) >= 200) {
    invalid_move_flashing = false;
    App_DisplayGameBoard();  // æ¢å¤æ­£å¸¸æ˜¾ç¤º
  }
}

/* Handle game result display (non-blocking) */
if (game_result_displaying) {
  if ((HAL_GetTick() - game_result_display_start) >= 3000) {
    game_result_displaying = false;
    // æ¢å¤æ­£å¸¸æ˜¾ç¤º
  }
}

/* Protocol maintenance tasks */
Protocol_Task();

/* Reduce delay to improve responsiveness */
// HAL_Delay(1);  // âŒ ç§»é™¤æˆ–å‡å°‘åˆ°0
// æ”¹ç”¨__WFI()ç­‰å¾…ä¸­æ–­ï¼ˆæ›´èŠ‚èƒ½ï¼‰
```

#### æ–¹æ¡ˆ2: å‡å°‘ä¸»å¾ªç¯å»¶è¿Ÿ

**ä¿®æ”¹ `main.c:254`**:
```c
// å°†å»¶è¿Ÿä»1mså‡å°‘åˆ°0ï¼ˆå®Œå…¨å»é™¤ï¼‰
// HAL_Delay(1);  // âŒ åˆ é™¤

// æˆ–è€…ä½¿ç”¨æ›´çŸ­çš„å»¶è¿Ÿ
// HAL_Delay(0);  // âœ… ä¸é˜»å¡ï¼Œç«‹å³è¿”å›

// æœ€ä½³æ–¹æ¡ˆï¼šä½¿ç”¨WFIï¼ˆç­‰å¾…ä¸­æ–­ï¼‰
// __WFI();  // âœ… CPUè¿›å…¥ç¡çœ ï¼Œç­‰å¾…ä¸­æ–­å”¤é†’
```

**ä¿®æ”¹æ–‡ä»¶**: `Core/Src/main.c` (å¤šå¤„ä¿®æ”¹)

---

## ğŸ”´ æ ¸å¿ƒé—®é¢˜3: ä¸Šä½æœºå‘é€èµ°æ£‹æ—¶çš„åŒæ­¥é˜»å¡

### é—®é¢˜æ ¹æºï¼ˆå·²ç¡®è®¤ï¼‰

**ä¸Šä½æœºå‘é€æµç¨‹** (`main_window.py:749-772`):
```python
def _on_player_move(self, row: int, col: int):
    current_player = self.game_manager.current_game.current_player.value

    # éªŒè¯èµ°æ³•
    if not game_state.is_valid_move(row, col, game_state.current_player):
        return

    success = self.game_manager.make_move(row, col)  # âœ… ç«‹å³æ›´æ–°æœ¬åœ°

    if success:
        # æ›´æ–°UI
        self.game_board.update_board()              # âœ… ç«‹å³æ˜¾ç¤º
        self.game_board.highlight_last_move()

        # å‘é€åˆ°STM32ï¼ˆåŒæ­¥å‘é€ï¼‰
        if self.serial_handler.is_connected():
            self.serial_handler.send_make_move(row, col, current_player)  # âš ï¸ åŒæ­¥é˜»å¡
```

**å‘é€é˜Ÿåˆ—å¤„ç†** (`serial_handler.py:473-499`):
```python
def _send_worker(self):
    """å‘é€æ•°æ®å·¥ä½œçº¿ç¨‹"""
    while self.running:
        try:
            # ä»é˜Ÿåˆ—è·å–æ•°æ®åŒ…
            packet = self.send_queue.get(timeout=1.0)  # âš ï¸ é˜»å¡ç­‰å¾…

            if self.serial_port and self.serial_port.is_open:
                self.serial_port.write(packet)         # âš ï¸ åŒæ­¥å†™å…¥
                self.serial_port.flush()               # âš ï¸ ç­‰å¾…å‘é€å®Œæˆ
```

### é—®é¢˜åˆ†æ

1. **å‘é€æ˜¯å¼‚æ­¥çš„ï¼ˆé€šè¿‡é˜Ÿåˆ—ï¼‰**:
   - âœ… `send_make_move()` åªæ˜¯å°†æ•°æ®æ”¾å…¥é˜Ÿåˆ—ï¼Œä¸é˜»å¡
   - âœ… æœ‰ç‹¬ç«‹çš„å‘é€çº¿ç¨‹å¤„ç†
   - âœ… ä¸Šä½æœºUIä¸ä¼šå› å‘é€è€Œå¡é¡¿

2. **ä½†ä¸‹ä½æœºå“åº”æ…¢**:
   - ä¸Šä½æœºå‘é€åï¼Œç«‹å³ç»§ç»­ï¼ˆä¸ç­‰å¾…å“åº”ï¼‰
   - ä¸‹ä½æœºæ”¶åˆ°åï¼Œå¯èƒ½åœ¨`HAL_Delay()`ä¸­å»¶è¿Ÿå¤„ç†
   - ä¸‹ä½æœºå¤„ç†å®Œåï¼Œå†å‘é€çŠ¶æ€å›ä¸Šä½æœº
   - **æ€»å»¶è¿Ÿ**: å‘é€æ—¶é—´ + ä¸‹ä½æœºå¤„ç† + å›ä¼ æ—¶é—´

3. **ç¼ºå°‘ACKæœºåˆ¶**:
   - ä¸Šä½æœºä¸çŸ¥é“å‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
   - ä¸Šä½æœºä¸çŸ¥é“ä½•æ—¶æ›´æ–°å®Œæˆ

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: ä¼˜åŒ–ä¸‹ä½æœºå“åº”é€Ÿåº¦ï¼ˆæœ€æœ‰æ•ˆï¼‰

**ä¿®æ”¹ä¸‹ä½æœºå‘½ä»¤å¤„ç†** (`main.c:1025-1050`):
```c
case CMD_MAKE_MOVE:
{
    if (len < sizeof(Move_Command_Data_t)) {
        Protocol_SendAck(cmd, 3);  // Error: invalid length
        break;
    }

    Move_Command_Data_t* move_cmd = (Move_Command_Data_t*)data;
    uint8_t row = move_cmd->row;
    uint8_t col = move_cmd->col;
    PieceType_t player = (PieceType_t)move_cmd->player;

    // âœ… ç«‹å³å¤„ç†èµ°æ³•
    if (Othello_IsValidMove(&game_state, row, col, player)) {
        uint8_t flipped = Othello_MakeMove(&game_state, row, col, player);
        if (flipped > 0) {
            // âœ… ç«‹å³å‘é€ACK
            Protocol_SendAck(cmd, 0);  // Success

            // âœ… ç«‹å³æ›´æ–°LEDï¼ˆä¸è¦ç­‰å¾…ï¼‰
            App_DisplayGameBoard();

            // âœ… ç«‹å³å‘é€æ›´æ–°åçš„çŠ¶æ€
            Send_GameState_Via_Protocol(&game_state);

            DEBUG_INFO("[PROTOCOL] Move SUCCESS from PC: (%d,%d) player=%d, flipped=%d\r\n",
                       row, col, player, flipped);
        } else {
            Protocol_SendAck(cmd, 2);  // Error: move failed
        }
    } else {
        Protocol_SendAck(cmd, 1);  // Error: invalid move
    }
    break;
}
```

**ä¼˜å…ˆçº§è°ƒæ•´**: ç¡®ä¿åè®®å¤„ç†åœ¨ä¸»å¾ªç¯ä¸­**ä¼˜å…ˆæ‰§è¡Œ**:
```c
while (1)
{
  /* USER CODE BEGIN 3 */

  // âœ… ä¼˜å…ˆå¤„ç†åè®®å‘½ä»¤ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
  Protocol_Task();

  // âœ… æ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ•°æ®åŒ…
  if (Protocol_IsPacketReady()) {
    uint8_t cmd_data[256];
    uint8_t cmd_len;
    Protocol_Command_t cmd;

    if (Protocol_GetPacket(&cmd, cmd_data, &cmd_len) == PROTOCOL_OK) {
      Protocol_Command_Handler(cmd, cmd_data, cmd_len);
    }
  }

  // ç„¶åå¤„ç†å…¶ä»–ä»»åŠ¡
  Keypad_Scan_Task();

  // ç§»é™¤æˆ–å‡å°‘å»¶è¿Ÿ
  // HAL_Delay(1);  // âŒ åˆ é™¤
}
```

**ä¿®æ”¹æ–‡ä»¶**: `Core/Src/main.c` (ç¬¬1025-1050è¡Œï¼Œä¸»å¾ªç¯)

#### æ–¹æ¡ˆ2: ä¸Šä½æœºå¢åŠ è¶…æ—¶æ£€æµ‹ï¼ˆæ¬¡è¦ï¼‰

**ä¿®æ”¹ `main_window.py`**:
```python
def _on_player_move(self, row: int, col: int):
    current_player = self.game_manager.current_game.current_player.value

    if not game_state.is_valid_move(row, col, game_state.current_player):
        return

    success = self.game_manager.make_move(row, col)

    if success:
        self.game_board.update_board()
        self.game_board.highlight_last_move()

        # å‘é€åˆ°STM32
        if self.serial_handler.is_connected():
            send_success = self.serial_handler.send_make_move(row, col, current_player)

            if send_success:
                self.logger.info(f"èµ°æ£‹å‘½ä»¤å·²å‘é€: ({row},{col})")

                # âœ… è®¾ç½®è¶…æ—¶æ£€æµ‹ï¼ˆå¯é€‰ï¼‰
                self._waiting_for_ack = True
                self._ack_timeout = time.time() + 1.0  # 1ç§’è¶…æ—¶
            else:
                self.logger.error("å‘é€èµ°æ£‹å‘½ä»¤å¤±è´¥")
```

**ä¿®æ”¹æ–‡ä»¶**: `OthelloPC/gui/main_window.py` (ç¬¬749-785è¡Œ)

---

## âš ï¸ æ¬¡è¦é—®é¢˜: ä¸²å£å‚æ•°è®¾ç½®ä¸ç”Ÿæ•ˆ

### é—®é¢˜æ ¹æºï¼ˆå·²ç¡®è®¤ï¼‰

**UIæä¾›äº†å®Œæ•´çš„è®¾ç½®** (`serial_settings_dialog.py:116-150`):
```python
# æ•°æ®ä½é€‰æ‹©
self.data_combo = ttk.Combobox(
    values=['5', '6', '7', '8'],  # âœ… æä¾›äº†é€‰é¡¹
    ...
)

# åœæ­¢ä½é€‰æ‹©
self.stop_combo = ttk.Combobox(
    values=['1', '1.5', '2'],     # âœ… æä¾›äº†é€‰é¡¹
    ...
)

# æ ¡éªŒä½é€‰æ‹©
self.parity_combo = ttk.Combobox(
    values=['None', 'Odd', 'Even', 'Mark', 'Space'],  # âœ… æä¾›äº†é€‰é¡¹
    ...
)
```

**ä½†è¿æ¥æ—¶ç¡¬ç¼–ç äº†å‚æ•°** (`serial_handler.py:197-204`):
```python
self.serial_port = serial.Serial(
    port=self.port_name,
    baudrate=self.baud_rate,
    bytesize=serial.EIGHTBITS,      # âŒ ç¡¬ç¼–ç 
    parity=serial.PARITY_NONE,      # âŒ ç¡¬ç¼–ç 
    stopbits=serial.STOPBITS_ONE,   # âŒ ç¡¬ç¼–ç 
    timeout=1.0,
    write_timeout=1.0
)
```

### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹ `serial_handler.py:167-234`**:

```python
def connect(self, port: str = None, baud_rate: int = None) -> bool:
    """è¿æ¥ä¸²å£"""
    try:
        # æ–­å¼€ç°æœ‰è¿æ¥
        if self.is_connected():
            self.disconnect()

        # è®¾ç½®å‚æ•°
        if port:
            self.port_name = port
        elif not self.port_name:
            self.port_name = self._auto_detect_port()
            if not self.port_name:
                self.logger.error("æœªæ‰¾åˆ°STM32è®¾å¤‡")
                return False

        if baud_rate:
            self.baud_rate = baud_rate

        # âœ… ä»configè¯»å–ä¸²å£å‚æ•°
        data_bits_map = {
            5: serial.FIVEBITS,
            6: serial.SIXBITS,
            7: serial.SEVENBITS,
            8: serial.EIGHTBITS
        }
        stop_bits_map = {
            1: serial.STOPBITS_ONE,
            1.5: serial.STOPBITS_ONE_POINT_FIVE,
            2: serial.STOPBITS_TWO
        }
        parity_map = {
            'None': serial.PARITY_NONE,
            'Odd': serial.PARITY_ODD,
            'Even': serial.PARITY_EVEN,
            'Mark': serial.PARITY_MARK,
            'Space': serial.PARITY_SPACE
        }

        # è·å–é…ç½®å€¼
        data_bits = self.config.get('serial.data_bits', 8) if self.config else 8
        stop_bits = self.config.get('serial.stop_bits', 1) if self.config else 1
        parity_str = self.config.get('serial.parity', 'None') if self.config else 'None'

        # è½¬æ¢ä¸ºpyserialå¸¸é‡
        bytesize = data_bits_map.get(data_bits, serial.EIGHTBITS)
        stopbits = stop_bits_map.get(stop_bits, serial.STOPBITS_ONE)
        parity = parity_map.get(parity_str, serial.PARITY_NONE)

        # è®°å½•é…ç½®
        self.logger.info(f"ä¸²å£é…ç½®: {self.port_name}, {self.baud_rate}bps, {data_bits}{parity_str[0]}{stop_bits}")

        # åˆ›å»ºä¸²å£è¿æ¥ï¼ˆä½¿ç”¨é…ç½®å‚æ•°ï¼‰
        self.serial_port = serial.Serial(
            port=self.port_name,
            baudrate=self.baud_rate,
            bytesize=bytesize,      # âœ… ä½¿ç”¨é…ç½®
            parity=parity,          # âœ… ä½¿ç”¨é…ç½®
            stopbits=stopbits,      # âœ… ä½¿ç”¨é…ç½®
            timeout=1.0,
            write_timeout=1.0
        )

        if not self.serial_port.is_open:
            self.serial_port.open()

        # æ¸…ç©ºç¼“å†²åŒº
        self.serial_port.reset_input_buffer()
        self.serial_port.reset_output_buffer()

        # å¯åŠ¨é€šä¿¡çº¿ç¨‹
        self.running = True
        self.receive_thread = threading.Thread(target=self._receive_worker, daemon=True)
        self.send_thread = threading.Thread(target=self._send_worker, daemon=True)

        self.receive_thread.start()
        self.send_thread.start()

        self.connection_status = True
        self.stats['reconnect_count'] += 1
        self.logger.info(f"âœ… æˆåŠŸè¿æ¥ä¸²å£: {self.port_name}")

        # å‘é€åˆå§‹åŒ–å‘½ä»¤
        self.send_system_info_request()

        return True

    except Exception as e:
        self.logger.error(f"è¿æ¥ä¸²å£å¤±è´¥: {e}")
        self.connection_status = False
        return False
```

**ä¿®æ”¹æ–‡ä»¶**: `OthelloPC/communication/serial_handler.py` (ç¬¬167-234è¡Œ)

---

## ğŸ“‹ å®Œæ•´ä¿®æ”¹æ¸…å•

### ä¼˜å…ˆçº§1: æ•°æ®åŒæ­¥é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

| æ–‡ä»¶ | è¡Œæ•° | ä¿®æ”¹å†…å®¹ | é¢„æœŸæ•ˆæœ |
|------|------|----------|----------|
| `OthelloPC/game/game_state.py` | 290-320 | å®Œæ•´è§£æ72å­—èŠ‚æ•°æ® | ä¸‹ä½æœºä¸‹æ£‹åä¸Šä½æœºå®Œå…¨åŒæ­¥ |

### ä¼˜å…ˆçº§2: å»¶è¿Ÿé—®é¢˜ï¼ˆä¸¥é‡å½±å“ä½“éªŒï¼‰

| æ–‡ä»¶ | è¡Œæ•° | ä¿®æ”¹å†…å®¹ | é¢„æœŸæ•ˆæœ |
|------|------|----------|----------|
| `Core/Src/main.c` | 254 | ç§»é™¤`HAL_Delay(1)` | ä¸»å¾ªç¯å»¶è¿Ÿä»2msé™è‡³<1ms |
| `Core/Src/main.c` | 680 | æ”¹ä¸ºéé˜»å¡é—ªçƒ | æ— æ•ˆèµ°æ³•ä¸é˜»å¡200ms |
| `Core/Src/main.c` | 851,856,889 | æ”¹ä¸ºéé˜»å¡æ˜¾ç¤º | æ¸¸æˆç»“æŸä¸é˜»å¡3-5ç§’ |
| `Core/Src/main.c` | 240-255 | è°ƒæ•´å¤„ç†é¡ºåº | ä¼˜å…ˆå¤„ç†åè®®å‘½ä»¤ |

### ä¼˜å…ˆçº§3: ä¸²å£å‚æ•°ï¼ˆåŠŸèƒ½å®Œå–„ï¼‰

| æ–‡ä»¶ | è¡Œæ•° | ä¿®æ”¹å†…å®¹ | é¢„æœŸæ•ˆæœ |
|------|------|----------|----------|
| `OthelloPC/communication/serial_handler.py` | 197-204 | ä»configè¯»å–å‚æ•° | ä¸²å£è®¾ç½®ç”Ÿæ•ˆ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯è®¡åˆ’

### æµ‹è¯•1: æ•°æ®åŒæ­¥éªŒè¯

**æ­¥éª¤**:
1. å¯åŠ¨ä¸Šä½æœºå’Œä¸‹ä½æœº
2. åœ¨ä¸‹ä½æœºæŒ‰é”®ä¸‹æ£‹ï¼ˆKEY_5ï¼‰
3. è§‚å¯Ÿä¸Šä½æœºæ˜¯å¦ï¼š
   - âœ… æ£‹ç›˜ç«‹å³æ›´æ–°
   - âœ… å½“å‰ç©å®¶æ­£ç¡®åˆ‡æ¢
   - âœ… åˆ†æ•°æ­£ç¡®æ˜¾ç¤º

**é¢„æœŸç»“æœ**: ä¸‹ä½æœºä¸‹æ£‹å1ç§’å†…ä¸Šä½æœºå®Œå…¨åŒæ­¥

### æµ‹è¯•2: å»¶è¿Ÿæµ‹è¯•

**æ­¥éª¤**:
1. ä¸Šä½æœºç‚¹å‡»ä¸‹æ£‹
2. æµ‹é‡ä»ç‚¹å‡»åˆ°ä¸‹ä½æœºLEDæ›´æ–°çš„æ—¶é—´
3. ä¸‹ä½æœºæŒ‰é”®ä¸‹æ£‹
4. æµ‹é‡ä»æŒ‰é”®åˆ°ä¸Šä½æœºæ˜¾ç¤ºçš„æ—¶é—´

**é¢„æœŸç»“æœ**:
- ä¸Šä½æœºâ†’ä¸‹ä½æœºå»¶è¿Ÿ: <200ms
- ä¸‹ä½æœºâ†’ä¸Šä½æœºå»¶è¿Ÿ: <200ms

### æµ‹è¯•3: æ— æ•ˆèµ°æ³•æµ‹è¯•

**æ­¥éª¤**:
1. ä¸‹ä½æœºç§»åŠ¨å…‰æ ‡åˆ°æ— æ•ˆä½ç½®
2. æŒ‰KEY_5å°è¯•ä¸‹æ£‹
3. è§‚å¯Ÿï¼š
   - LEDæ˜¯å¦çº¢è‰²é—ªçƒ200ms
   - æœŸé—´èƒ½å¦å¤„ç†ä¸Šä½æœºå‘½ä»¤

**é¢„æœŸç»“æœ**: çº¢è‰²é—ªçƒæœŸé—´ä»å¯æ¥æ”¶å‘½ä»¤

### æµ‹è¯•4: ä¸²å£å‚æ•°æµ‹è¯•

**æ­¥éª¤**:
1. æ‰“å¼€ä¸²å£è®¾ç½®å¯¹è¯æ¡†
2. ä¿®æ”¹æ•°æ®ä½ä¸º7ä½
3. ä¿å­˜å¹¶é‡æ–°è¿æ¥
4. ä½¿ç”¨ä¸²å£ç›‘æ§å·¥å…·éªŒè¯

**é¢„æœŸç»“æœ**: å®é™…ä¸²å£å‚æ•°ä¸º7ä½æ•°æ®ä½

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–é¢„æœŸ

### ä¿®å¤å‰

| æŒ‡æ ‡ | å½“å‰å€¼ | é—®é¢˜ |
|------|--------|------|
| ä¸»å¾ªç¯å»¶è¿Ÿ | 2ms | ç´¯ç§¯å»¶è¿Ÿå½±å“å“åº” |
| ä¸‹ä½æœºâ†’ä¸Šä½æœºåŒæ­¥ | âŒ ä¸åŒæ­¥ | æ•°æ®æ ¼å¼ä¸åŒ¹é… |
| ä¸Šä½æœºâ†’ä¸‹ä½æœºå»¶è¿Ÿ | 300-500ms | é˜»å¡å»¶è¿Ÿç´¯ç§¯ |
| æ— æ•ˆèµ°æ³•é˜»å¡ | 200ms | æœŸé—´æ— æ³•å“åº” |
| æ¸¸æˆç»“æŸé˜»å¡ | 3-5ç§’ | æœŸé—´æ— æ³•å“åº” |

### ä¿®å¤å

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æ”¹è¿› |
|------|--------|------|
| ä¸»å¾ªç¯å»¶è¿Ÿ | <0.5ms | âœ… å»¶è¿Ÿé™ä½75% |
| ä¸‹ä½æœºâ†’ä¸Šä½æœºåŒæ­¥ | âœ… å®Œå…¨åŒæ­¥ | âœ… æ•°æ®æ ¼å¼åŒ¹é… |
| ä¸Šä½æœºâ†’ä¸‹ä½æœºå»¶è¿Ÿ | <200ms | âœ… å»¶è¿Ÿé™ä½50% |
| æ— æ•ˆèµ°æ³•å“åº” | ä¸é˜»å¡ | âœ… æ”¹ä¸ºå¼‚æ­¥ |
| æ¸¸æˆç»“æŸå“åº” | ä¸é˜»å¡ | âœ… æ”¹ä¸ºå¼‚æ­¥ |

---

## ğŸ’¡ å®æ–½å»ºè®®

### å®æ–½é¡ºåº

1. **ç¬¬ä¸€æ­¥**: ä¿®å¤æ•°æ®åŒæ­¥é—®é¢˜ï¼ˆæœ€å…³é”®ï¼‰
   - ä¿®æ”¹ `game_state.py:update_board_state()`
   - æµ‹è¯•ä¸‹ä½æœºä¸‹æ£‹â†’ä¸Šä½æœºåŒæ­¥

2. **ç¬¬äºŒæ­¥**: ä¼˜åŒ–ä¸»å¾ªç¯å»¶è¿Ÿ
   - ç§»é™¤ `main.c:254` çš„ `HAL_Delay(1)`
   - è°ƒæ•´åè®®å¤„ç†ä¼˜å…ˆçº§
   - æµ‹è¯•æ•´ä½“å“åº”é€Ÿåº¦

3. **ç¬¬ä¸‰æ­¥**: æ”¹ä¸ºéé˜»å¡æ˜¾ç¤º
   - ä¿®æ”¹æ— æ•ˆèµ°æ³•å¤„ç†ï¼ˆmain.c:680ï¼‰
   - ä¿®æ”¹æ¸¸æˆç»“æŸå¤„ç†ï¼ˆmain.c:851,856,889ï¼‰
   - æµ‹è¯•å¼‚æ­¥æ˜¾ç¤ºæ•ˆæœ

4. **ç¬¬å››æ­¥**: ä¿®å¤ä¸²å£å‚æ•°
   - ä¿®æ”¹ `serial_handler.py:connect()`
   - æµ‹è¯•å‚æ•°æ˜¯å¦ç”Ÿæ•ˆ

### é£é™©è¯„ä¼°

| ä¿®æ”¹ | é£é™©ç­‰çº§ | é£é™©è¯´æ˜ | ç¼“è§£æªæ–½ |
|------|----------|----------|----------|
| æ•°æ®åŒæ­¥ | ğŸŸ¢ ä½ | åªæ”¹ä¸Šä½æœºæ¥æ”¶é€»è¾‘ | ä¿ç•™åŸä»£ç æ³¨é‡Šï¼Œå¯å¿«é€Ÿå›æ»š |
| ç§»é™¤å»¶è¿Ÿ | ğŸŸ¡ ä¸­ | å¯èƒ½å½±å“ç¨³å®šæ€§ | å…ˆå‡å°‘åˆ°0.5msæµ‹è¯• |
| éé˜»å¡æ˜¾ç¤º | ğŸŸ¡ ä¸­ | çŠ¶æ€æœºé€»è¾‘å¤æ‚ | åˆ†æ­¥å®ç°ï¼Œé€ä¸ªæµ‹è¯• |
| ä¸²å£å‚æ•° | ğŸŸ¢ ä½ | åªæ”¹ä¸Šä½æœºè¿æ¥ | ä¿æŒé»˜è®¤å€¼8N1 |

---

## ğŸ“Š é—®é¢˜æ ¹å› æ€»ç»“

| é—®é¢˜ | æ ¹æœ¬åŸå›  | å½±å“ |
|------|----------|------|
| ä¸åŒæ­¥ | æ•°æ®æ ¼å¼å‡è®¾é”™è¯¯ | ğŸ”´ ä¸¥é‡ - æ¸¸æˆé€»è¾‘æ··ä¹± |
| å»¶è¿Ÿ | é˜»å¡å»¶è¿Ÿç´¯ç§¯ | ğŸ”´ ä¸¥é‡ - ç”¨æˆ·ä½“éªŒå·® |
| ä¸²å£å‚æ•° | ç¡¬ç¼–ç æœªè¯»é…ç½® | ğŸŸ¡ ä¸­ç­‰ - åŠŸèƒ½ä¸å®Œå–„ |

---

**æ–‡æ¡£ç»“æŸ**

ä¸‹ä¸€æ­¥ï¼šç­‰å¾…ç”¨æˆ·ç¡®è®¤åï¼ŒæŒ‰ç…§å®æ–½é¡ºåºé€æ­¥ä¿®æ”¹ä»£ç ã€‚
